"use strict";class TinybufError extends Error{}class EncodeError extends TinybufError{constructor(t,r,e){super(`Failed to encode ${r} as '${t}'${e?` (path: '${e}')`:""}`)}}class DecodeError extends TinybufError{constructor(t,r){super(`${t}: ${r.message}`),this.cause=r,this.stack=r.stack}}function $hashCode(t){let r=5381;for(let e=0;e<t.length;e++)r=33*r^t.charCodeAt(e);return 65535&r}function $strToHashCode(t){return 2!==t.length?$hashCode(t):256*t.charCodeAt(0)+t.charCodeAt(1)}function $hashCodeToStr(t){return String.fromCharCode(Math.floor(t/256))+String.fromCharCode(t%256)}function peekHeader(t){return new DataView(t instanceof ArrayBuffer?t:t.buffer).getUint16(0,!1)}function peekHeaderStr(t){return $hashCodeToStr(peekHeader(t))}class BufferParserInstance{constructor(){this.o=new Map}processBuffer(t){let r,e,n;try{const i=peekHeader(t);if(!this.o.has(i))throw new TinybufError(`Unknown format: ${i} '${$hashCodeToStr(i)}')`);[r,n]=this.o.get(i),e=r.decode(t)}catch(t){throw new DecodeError("Failed to decode",t)}n(e)}on(t,r,e=!1){if(null==t.header)throw new TinybufError("Format requires header");const n="string"==typeof t.header?$strToHashCode(t.header):t.header;if(this.o.has(n)&&!e)throw new TinybufError(`Format header collision: ${t.header}`);return this.o.set(n,[t,r]),this}ignore(...t){return t.forEach((t=>this.on(t,(()=>{}),!0))),this}clear(){this.o.clear()}}function clamp(t,r,e){return Math.min(Math.max(t,r),e)}function r2z(t){return t<0?Math.ceil(t):Math.floor(t)}function raz(t){return t<0?Math.floor(t):Math.ceil(t)}function toUScalar8(t){return Number.isNaN(t)?255:clamp(127+r2z(254*t-127),0,254)}function toScalar8(t){return Number.isNaN(t)?255:clamp(r2z(127*t),-127,127)+127}function fromUScalar8(t){return 255===t?NaN:clamp(.01*(raz(.3937007874015748*(t-127))+50),0,1)}function fromScalar8(t){return 255===t?NaN:clamp(.01*raz(.787401574803149*(t-127)),-1,1)}function $bools2Mask(t,r){let e="";for(let n=0;n<r;n++)e+=+!!t[n];return parseInt(e,2)}function $mask2Bools(t,r){return[...(t>>>0).toString(2).padStart(r,"0")].map((t=>"0"!=t))}function $vBools2Mask(t){let r="";for(let e=0;e<t.length;e++)r+=+!!t[e];return parseInt(r,2)}const t=268435456,r=2147483647,e=4294967296,n=new TextDecoder("utf-8"),i={u:function(t,r,n){if("number"!=typeof t||t>Number.MAX_SAFE_INTEGER||t<0)throw new EncodeError("uint",t,n);if(t<128)r.h(r2z(t));else if(t<16384)r.l(r2z(t)+32768);else if(t<536870912)r.$(r2z(t)+3221225472);else{const n=r2z(t);r.$(Math.floor(n/e)+3758096384),r.$(n>>>0)}},p:function(t){const r=t.m();return 128&r?64&r?32&r?(t.B()-3758096384)*e+t.B():t.B()-3221225472:t.F()-32768:(t.S(),r)}},o={u:function(r,n,i){if("number"!=typeof r||r>Number.MAX_SAFE_INTEGER||r<-Number.MAX_SAFE_INTEGER)throw new EncodeError("int",r,i);if(r>=-64&&r<64)n.h(127&r2z(r));else if(r>=-8192&&r<8192)n.l(32768+(16383&r2z(r)));else if(r>=-268435456&&r<t)n.$(3221225472+(536870911&r2z(r)));else{const t=r2z(r);n.$(3758096384+(536870911&Math.floor(t/e))),n.$(t>>>0)}},p:function(t){let r,n=t.m();return 128&n?64&n?32&n?(r=t.B()-3758096384,r=268435456&r?3758096384|r:r,r*e+t.B()):(r=t.B()-3221225472,268435456&r?3758096384|r:r):(r=t.F()-32768,8192&r?4294950912|r:r):(t.S(),64&n?4294967168|n:n)}},s={u:function(t,r,e){a.u((new TextEncoder).encode(null!=t?t:""),r,e)},p:function(t){return n.decode(a.p(t))}},a={u:function(t,r,e){i.u(t.byteLength,r,e),r.T(t)},p:function(t){return t.k(i.p(t))}},f={u:function(t,r){r.h(t?1:0)},p:function(t){return 0!==t.A()}},u={u:function(t,r,e){let n;try{n=JSON.stringify(t)}catch(t){throw new EncodeError("JSON",t,e)}s.u(n,r,e)},p:function(t){const r=s.p(t);return JSON.parse(r)}},c={u:function(t,r,e){if(!(t instanceof RegExp))throw new EncodeError("RegExp",t,e);let n,i,o;s.u(t.source,r,e),n=t.global?1:0,i=t.ignoreCase?2:0,o=t.multiline?4:0,r.h(n+i+o)},p:function(t){const r=s.p(t),e=t.A();return new RegExp(r,(1&e?"g":"")+(2&e?"i":"")+(4&e?"m":""))}},h={u:function(t,r,e){if(!(t instanceof Date))throw new EncodeError("Date",t,e);{const n=t.getTime();if(isNaN(n))throw new EncodeError("Date","NaN",e);o.u(n,r,e)}},p:function(t){return new Date(o.p(t))}},d=[i,{u:function(t,r,e){if("number"!=typeof t||t<0||t>255)throw new EncodeError("uint8",t,e);r.h(r2z(t))},p:function(t){return t.A()}},{u:function(t,r,e){if("number"!=typeof t||t<0||t>65535)throw new EncodeError("uint16",t,e);r.l(r2z(t))},p:function(t){return t.F()}},{u:function(t,r,e){if("number"!=typeof t||t<0||t>4294967295)throw new EncodeError("uint32",t,e);r.$(r2z(t))},p:function(t){return t.B()}},o,{u:function(t,r,e){if("number"!=typeof t||t<-127||t>127)throw new EncodeError("int8",t,e);r.U(r2z(t))},p:function(t){return t.M()}},{u:function(t,r,e){if("number"!=typeof t||t<-32767||t>32767)throw new EncodeError("int16",t,e);r.v(r2z(t))},p:function(t){return t.I()}},{u:function(t,e,n){if("number"!=typeof t||t<-r||t>r)throw new EncodeError("int32",t,n);e.N(r2z(t))},p:function(t){return t.O()}},{u:function(t,r,e){if("number"!=typeof t)throw new EncodeError("number",t,e);r.H(t)},p:function(t){return t._()}},{u:function(t,r,e){if("number"!=typeof t)throw new EncodeError("number",t,e);r.D(t)},p:function(t){return t.j()}},{u:function(t,r,e){if("number"!=typeof t)throw new EncodeError("number",t,e);r.R(t)},p:function(t){return t.C()}},{u:function(t,r,e){if("number"!=typeof t)throw new EncodeError("number",t,e);r.h(toScalar8(t))},p:function(t){return fromScalar8(t.A())}},{u:function(t,r,e){if("number"!=typeof t)throw new EncodeError("number",t,e);r.h(toUScalar8(t))},p:function(t){return fromUScalar8(t.A())}},f,{u:function(t,r){for(let e=0;e<Math.max(1,t.length);e+=6){const n=$vBools2Mask([!0,e+6>=t.length,...t.slice(e,e+6)]);r.h(n)}},p:function(t){const r=[];let e=!1;for(;!e;){const n=[...(t.A()>>>0).toString(2)].map((t=>"0"!=t));n.shift(),e=n.shift(),r.push(...n)}return r}},{u:function(t,r){r.h($bools2Mask(t,8))},p:function(t){return $mask2Bools(t.A(),8)}},{u:function(t,r){r.l($bools2Mask(t,16))},p:function(t){return $mask2Bools(t.F(),16)}},{u:function(t,r){r.$($bools2Mask(t,32))},p:function(t){return $mask2Bools(t.B(),32)}},s,a,u,c,h];let w={encodingBufferMaxSize:1500,encodingBufferInitialSize:256,encodingBufferIncrement:256,useGlobalEncodingBuffer:!1};var l;const $=Math.pow(2,-24),p=function(){const t=new Float32Array(1),r=new Int32Array(t.buffer);return function toHalf(e){t[0]=e;const n=r[0];let i=n>>16&32768,o=n>>12&2047;const s=n>>23&255;return s<103?i:s>142?isNaN(e)?31745:(i|=31744,i|=(255==s?0:1)&&8388607&n,i):s<113?(o|=2048,i|=(o>>114-s)+(o>>113-s&1),i):(i|=s-112<<10|o>>1,i+=1&o,i)}}();function $f16unmask(t){return 32768&t?-f16.t[((t>>10&31)<<10)+(1023&t)]:f16.t[((t>>10&31)<<10)+(1023&t)]}class f16{static V(){const t=[];for(let r=0;r<32;r++)for(let e=0;e<1024;e++){const n=f16.W(r,e);t[(r<<10)+e]=n}return t}static W(t,r){return 0===t?0===r?0:$*(r/1024):31===t?0===r?1/0:NaN:(t-=15,Math.pow(2,t)*(1+r/1024))}}l=f16,f16.t=l.V();class BufferWriter{constructor(t){this.J=0,t instanceof ArrayBuffer?(this.P=t,this.q=!1):(this.P=new ArrayBuffer(t),this.q=!0),this.G=new DataView(this.P,0,this.P.byteLength)}L(){return new Uint8Array(this.G.buffer,0,this.J)}K(){return new Uint8Array(this.G.buffer.slice(0,this.J))}U(t){this.G.setInt8(this.X(1),t)}v(t){this.G.setInt16(this.X(2),t,!0)}N(t){this.G.setInt32(this.X(4),t,!0)}h(t){this.G.setUint8(this.X(1),t)}l(t){this.G.setUint16(this.X(2),t)}$(t){this.G.setUint32(this.X(4),t)}R(t){this.G.setUint16(this.X(2),p(t))}D(t){this.G.setFloat32(this.X(4),t,!0)}H(t){this.G.setFloat64(this.X(8),t,!0)}T(t){const r=this.X(t.byteLength),e=t instanceof Uint8Array?t:t instanceof ArrayBuffer?new Uint8Array(t):new Uint8Array(t.buffer,t.byteOffset,t.byteLength);new Uint8Array(this.G.buffer,r,t.byteLength).set(e)}X(t){if(this.J+t<=this.G.byteLength){const r=this.J;return this.J+=t,r}const r=this.G.byteLength,e=r+t;if(!this.q||e>w.encodingBufferMaxSize)throw new EncodeError(`exceeded max encoding buffer size: ${w.encodingBufferMaxSize}`);let n=this.G.byteLength;do{n=Math.min(n+w.encodingBufferIncrement,w.encodingBufferMaxSize)}while(n<this.J+t);const i=new ArrayBuffer(n),o=new Uint8Array(this.G.buffer,this.G.byteOffset,r);new Uint8Array(i).set(o),this.P=i,this.G=new DataView(i);const s=this.J;return this.J+=t,s}}class BufferReader{constructor(t,r){this.G=t instanceof ArrayBuffer?new DataView(t):new DataView(t.buffer,t.byteOffset,t.byteLength),this.i=null!=r?r:0}m(){return this.G.getUint8(this.i)}S(){this.i++}A(){return this.G.getUint8(this.i++)}F(){const t=this.G.getUint16(this.i);return this.i+=2,t}B(){const t=this.G.getUint32(this.i);return this.i+=4,t}M(){return this.G.getInt8(this.i++)}I(){const t=this.G.getInt16(this.i,!0);return this.i+=2,t}O(){const t=this.G.getInt32(this.i,!0);return this.i+=4,t}C(){const t=this.G.getUint16(this.i);return this.i+=2,$f16unmask(t)}j(){const t=this.G.getFloat32(this.i,!0);return this.i+=4,t}_(){const t=this.G.getFloat64(this.i,!0);return this.i+=8,t}k(t){if(this.i+t>this.G.byteLength)throw new RangeError;const r=new Uint8Array(this.G.buffer,this.i,t);return this.i+=t,r}}class OptionalType{constructor(t){this.type=t}}class BufferFormat{constructor(t,r){if(this.Y=!1,t instanceof OptionalType)throw new TypeError("Invalid encoding format: Root object cannot be optionals.");if(void 0!==t&&"number"==typeof t)this.Z=t;else{if(!(t instanceof Object))throw new TypeError("Invalid encoding format: Must be an object, or a known coder type.");if(this.Z=void 0,this.tt=new Map,this.rt=Object.keys(t).map((r=>{const e=new Field(r,t[r]);return this.tt.set(r,e),e})),void 0===r)this.header=$hashCode(this.f),this.et=this.header;else if(null===r)this.header=void 0,this.et=void 0;else{if(!function isValidHeader(t){return"number"==typeof t?Number.isInteger(t)&&t>=0&&t<=65535:"string"==typeof t&&2===(new TextEncoder).encode(t).byteLength}(r))throw new TypeError(`Header should be an integer between 0 and 65535, a 2-byte string, or null. Received: ${r}`);this.header=r,this.et="number"==typeof r?r:$strToHashCode(r)}}}get f(){return void 0===this.nt&&(this.nt=void 0!==this.rt?`{${this.rt.map((t=>t.f)).join(",")}}`:`${this.Z}`),this.nt}static it(){return w.useGlobalEncodingBuffer?(BufferFormat.ot||(BufferFormat.ot=new ArrayBuffer(w.encodingBufferMaxSize)),new BufferWriter(BufferFormat.ot)):new BufferWriter(w.encodingBufferInitialSize)}encode(t,r){return this.st||(this.st=BufferFormat.it()),this.st.J=0,this.Y&&(t=this.ft(t)),this.ut(t,this.st,""),r?this.st.K():this.st.L()}decode(t){return this.ct(new BufferReader(t,void 0===this.header?0:2))}setTransforms(t){if(this.Y=!0,t instanceof Function||Array.isArray(t)&&t[0]instanceof Function)this.ht=t;else for(const r of Object.keys(t)){const e=this.tt.get(r);if(!e)throw new TypeError(`Failed to set transforms for field '${r}'`);e.dt.setTransforms(t[r])}return this}setValidation(t){if(this.Y=!0,t instanceof Function)this.wt=t;else for(const r of Object.keys(t)){const e=this.tt.get(r);if(!e)throw new TypeError(`Failed to set validation function for field '${r}'`);e.dt.setValidation(t[r])}return this}ut(t,r,e){if(void 0!==this.et&&this.st.l(this.et),void 0!==this.Z){const n=this.wt||this.ht?this.ft(t):t;return d[this.Z].u(n,r,e)}if(!t||"object"!=typeof t)throw new TypeError(`Expected an object at ${e}`);for(const n of this.rt){const i=e?`${e}.${n.lt}`:n.lt,o=t[n.lt];if(n.$t){if(null==o){f.u(!1,r);continue}f.u(!0,r)}n.yt?this.Et(o,r,i,n.dt):n.dt.ut(o,r,i)}}ft(t){if(this.wt&&!1===this.wt(t))throw new Error("failed validation");return this.ht instanceof Function?this.ht(t):Array.isArray(this.ht)&&this.ht[0]instanceof Function?this.ht[0](t):t}bt(t){return Array.isArray(this.ht)&&this.ht[1]instanceof Function&&(t=this.ht[1](t)),this.wt instanceof Function&&this.wt(t),t}ct(t){return this.ct=this.Bt(),this.ct(t)}Ft(){return`return{${this.rt.map((({lt:t},r)=>`${t}:this.${this.xt.name}(${r},state)`)).join(",")}}`}xt(t,r){const e=this.rt[t];if(!e.$t||this.St(r))return e.yt?this.Tt(e.dt,r):e.dt.ct(r)}Bt(){return void 0!==this.Z?this.Y?t=>this.bt(d[this.Z].p(t)):d[this.Z].p:new Function("state",this.Ft())}Et(t,r,e,n){if(!Array.isArray(t))throw new EncodeError(`Array<${n.Z}>`,r,e);let o,s;for(s=t.length,i.u(s,r),o=0;o<s;o++)n.ut(t[o],r,e+"."+o)}Tt(t,r){const e=new Array(i.p(r));for(let n=0;n<e.length;n++)e[n]=t.ct(r);return e}St(t){return f.p(t)}}BufferFormat.peekHeader=peekHeader,BufferFormat.peekHeaderStr=peekHeaderStr;class Field{constructor(t,r){this.$t=r instanceof OptionalType;let e=r instanceof OptionalType?r.type:r;if(this.lt=t,Array.isArray(e)){if(1!==e.length)throw new TypeError("Invalid array definition, it must have exactly one element");e=e[0],this.yt=!0}else this.yt=!1;this.dt=new BufferFormat(e,null)}get f(){return void 0===this.kt&&(this.kt=`${this.dt.f}${this.yt?"[]":""}${this.$t?"?":""}`),this.kt}}exports.$f16mask=p,exports.$f16unmask=$f16unmask,exports.BufferFormat=BufferFormat,exports.BufferParserInstance=BufferParserInstance,exports.DecodeError=DecodeError,exports.EncodeError=EncodeError,exports.TinybufError=TinybufError,exports.bufferParser=()=>new BufferParserInstance,exports.defineFormat=function defineFormat(t,r){return null!==t&&"object"==typeof t?new BufferFormat(t):new BufferFormat(r,t)},exports.fromScalar8=fromScalar8,exports.fromUScalar8=fromUScalar8,exports.fround16=function fround16(t){return $f16unmask(p(t))},exports.optional=function optional(t){return new OptionalType(t)},exports.peekHeader=peekHeader,exports.peekHeaderStr=peekHeaderStr,exports.scalarRound=function scalarRound(t){return fromScalar8(toScalar8(t))},exports.setTinybufConfig=t=>{w=Object.assign(Object.assign({},w),t)},exports.toScalar8=toScalar8,exports.toUScalar8=toUScalar8,exports.uScalarRound=function uScalarRound(t){return fromUScalar8(toUScalar8(t))};
//# sourceMappingURL=index.cjs.map
