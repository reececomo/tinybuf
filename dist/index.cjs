class TinybufError extends Error{}function $hashCode(e){let t=5381;for(let r=0;r<e.length;r++)t=33*t^e.charCodeAt(r);return 65535&t}function $strToHashCode(e){return 2!==e.length?$hashCode(e):256*e.charCodeAt(0)+e.charCodeAt(1)}function $hashCodeToStr(e){return String.fromCharCode(Math.floor(e/256))+String.fromCharCode(e%256)}function peekHeader(e){return(ArrayBuffer.isView(e)?new DataView(e.buffer,e.byteOffset,2):new DataView(e,0,2)).getUint16(0,!1)}function peekHeaderStr(e){return $hashCodeToStr(peekHeader(e))}class BufferParser{constructor(){this._$formats=new Map}processBuffer(e){let t,r,i;try{const a=peekHeader(e);if(!this._$formats.has(a))throw new TinybufError(`Unknown format: ${a} '${$hashCodeToStr(a)}')`);[t,i]=this._$formats.get(a),r=t.decode(e)}catch(e){const t=new TinybufError(`Failed to decode: ${e}`);throw t.stack=e.stack,t}i(r)}on(e,t,r=!1){if(null==e.header)throw new TinybufError("Format requires header");const i="string"==typeof e.header?$strToHashCode(e.header):e.header;if(this._$formats.has(i)&&!r)throw new TinybufError(`Format header collision: ${e.header}`);return this._$formats.set(i,[e,t]),this}ignore(...e){return e.forEach((e=>this.on(e,(()=>{}),!0))),this}clear(){this._$formats.clear()}}const e=Math.floor,t=Math.ceil,$clamp=(e,t,r)=>e>r?r:e<t?t:e,$roundTowardZero=r=>r<0?t(r):e(r),$roundAwayFromZero=r=>r<0?e(r):t(r);function $touscal8(e){return $clamp(127+$roundTowardZero(254*e-127),0,254)}function $toscal8(e){return $clamp($roundTowardZero(127*e),-127,127)+127}function $fromuscal8(e){return $clamp(.01*($roundAwayFromZero(.3937007874015748*(e-127))+50),0,1)}function $fromscal8(e){return $clamp(.01*$roundAwayFromZero(.787401574803149*(e-127)),-1,1)}const mask=(e,t=1)=>e.reduce(((e,t)=>e<<1|t),t),unmask=(e,t=31-Math.clz32(e))=>{const r=new Array(t);for(let i=0;i<t;i++)r[i]=!!(e&1<<t-1-i);return r},r=function(){const e=new TextEncoder;return t=>e.encode(t)}(),i=function(){const e=new TextDecoder("utf-8");return t=>e.decode(t)}();const a=function(){const e=new Float32Array(1),t=new Int32Array(e.buffer);return function(r){e[0]=r;let i=t[0],a=i>>16&32768,n=4096+(2147483647&i)|0;return n>=1199570944?(2147483647&i)<1199570944?31743|a:n<2139095040?31744|a:31744|a|(8388607&i)>>13:n>=947912704?a|n-939524096>>13:n<855638016?a:(n=(2147483647&i)>>23,a|(8388607&i|8388608)+(8388608>>>n-102)>>126-n)}}(),n=function(){const e=Math.pow(2,-24),t=new Float32Array(1056);for(let e=0;e<32;e++)t[e]=Math.pow(2,e-15);for(let e=0;e<1024;e++)t[e+32]=1+e/1024;return function(r){const i=32768&~r?1:-1,a=31744&r,n=1023&r;return 0===a?0===n?0*i:i*e:31744===a?0===n?i*(1/0):NaN:t[a>>10]*t[n+32]*i}}(),s=268435456,o=4294967296,$={$write:(t,r)=>{t<128?r.$writeUint8(t):t<16384?r.$writeUint16(t+32768):t<536870912?r.$writeUint32(t+3221225472):(r.$writeUint32(e(t/o)+3758096384),r.$writeUint32(t>>>0))},$read:e=>{const t=e.$peek();return 128&t?64&t?32&t?(e.$readUint32()-3758096384)*o+e.$readUint32():e.$readUint32()-3221225472:e.$readUint16()-32768:(e.$skip(),t)}},d={$write:(e,t)=>t.$writeUint8(e),$read:e=>e.$readUint8()},f={$write:(e,t)=>t.$writeUint16(e),$read:e=>e.$readUint16()},h={$write:(e,t)=>t.$writeUint32(e),$read:e=>e.$readUint32()},w={$write:(t,r)=>{if(t>=-64&&t<64)r.$writeUint8(127&t);else if(t>=-8192&&t<8192)r.$writeUint16(32768+(16383&t));else if(t>=-268435456&&t<s)r.$writeUint32(3221225472+(536870911&t));else{const i=t;r.$writeUint32(3758096384+(536870911&e(i/o))),r.$writeUint32(i>>>0)}},$read:e=>{let t,r=e.$peek();return 128&r?64&r?32&r?(t=e.$readUint32()-3758096384,t=268435456&t?3758096384|t:t,t*o+e.$readUint32()):(t=e.$readUint32()-3221225472,268435456&t?3758096384|t:t):(t=e.$readUint16()-32768,8192&t?4294950912|t:t):(e.$skip(),64&r?4294967168|r:r)}},c={$write:(e,t)=>t.$writeInt8(e),$read:e=>e.$readInt8()},l={$write:(e,t)=>t.$writeInt16(e),$read:e=>e.$readInt16()},u={$write:(e,t)=>t.$writeInt32(e),$read:e=>e.$readInt32()},_={$write:(e,t)=>t.$writeUint16(a(e)),$read:e=>n(e.$readUint16())},y={$write:(e,t)=>t.$writeFloat32(e),$read:e=>e.$readFloat32()},p={$write:(e,t)=>t.$writeFloat64(e),$read:e=>e.$readFloat64()},m={$write:(e,t)=>t.$writeUint8($touscal8(e)),$read:e=>$fromuscal8(e.$readUint8())},g={$write:(e,t)=>t.$writeUint8($toscal8(e)),$read:e=>$fromscal8(e.$readUint8())},b={$write:(e,t)=>w.$write(e.getTime(),t),$read:e=>new Date(w.$read(e))},U={$write:(e,t)=>V.$write(r(null!=e?e:""),t),$read:e=>i(V.$read(e))},V={$write:(e,t)=>{$.$write(e.byteLength,t),t.$writeBytes(e)},$read:e=>e.$readBytes($.$read(e))},B={$write:(e,t)=>t.$writeUint8(e?1:0),$read:e=>0!==e.$readUint8()},F={$write:(e,t)=>{e.length>28&&(e=e.slice(0,28)),$.$write(mask(e),t)},$read:e=>unmask($.$read(e))},T={$write:(e,t)=>U.$write(JSON.stringify(e),t),$read:e=>JSON.parse(U.$read(e))},A={$write:(e,t)=>{t.$writeUint8(mask([e.global,e.ignoreCase,e.multiline])),U.$write(e.source,t)},$read:e=>{const[t,r,i]=unmask(e.$readUint8());return new RegExp(U.$read(e),(t?"g":"")+(r?"i":"")+(i?"m":""))}},I=[$.$write,d.$write,f.$write,h.$write,w.$write,c.$write,l.$write,u.$write,p.$write,y.$write,_.$write,g.$write,m.$write,B.$write,F.$write,V.$write,U.$write,T.$write,A.$write,b.$write],x=[$.$read,d.$read,f.$read,h.$read,w.$read,c.$read,l.$read,u.$read,p.$read,y.$read,_.$read,g.$read,m.$read,B.$read,F.$read,V.$read,U.$read,T.$read,A.$read,b.$read];let S={safe:!1,useGlobalEncodingBuffer:!0,encodingBufferMaxSize:1500,encodingBufferInitialSize:256,encodingBufferIncrement:256};class BufferWriter{constructor(e){this.i=0,this._$dataView=new DataView(new ArrayBuffer(e))}$viewBytes(){return new Uint8Array(this._$dataView.buffer,this._$dataView.byteOffset,this.i)}$copyBytes(){return new Uint8Array(this._$dataView.buffer.slice(0,this.i))}$writeInt8(e){this._$dataView.setInt8(this._$alloc(1),e)}$writeInt16(e){this._$dataView.setInt16(this._$alloc(2),e,!0)}$writeInt32(e){this._$dataView.setInt32(this._$alloc(4),e,!0)}$writeUint8(e){this._$dataView.setUint8(this._$alloc(1),e)}$writeUint16(e){this._$dataView.setUint16(this._$alloc(2),e,!1)}$writeUint32(e){this._$dataView.setUint32(this._$alloc(4),e,!1)}$writeFloat32(e){this._$dataView.setFloat32(this._$alloc(4),e,!0)}$writeFloat64(e){this._$dataView.setFloat64(this._$alloc(8),e,!0)}$writeBytes(e){const t=this._$alloc(e.byteLength),r=ArrayBuffer.isView(e)?e instanceof Uint8Array?e:new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e);new Uint8Array(this._$dataView.buffer,this._$dataView.byteOffset+t,e.byteLength).set(r)}_$alloc(e){if(this.i+e>this._$dataView.byteLength){const t=this.i+e-this._$dataView.byteLength,r=Math.ceil(t/S.encodingBufferIncrement)*S.encodingBufferIncrement;this._$resizeBuffer(this._$dataView.byteLength+r)}const t=this.i;return this.i+=e,t}_$resizeBuffer(e){if(e>S.encodingBufferMaxSize)throw new TinybufError(`exceeded encodingBufferMaxSize: ${S.encodingBufferMaxSize}`);const t=new ArrayBuffer(e),r=new Uint8Array(this._$dataView.buffer,this._$dataView.byteOffset,this._$dataView.byteLength);new Uint8Array(t).set(r),this._$dataView=new DataView(t)}}class BufferReader{constructor(e,t){this._$dataView=ArrayBuffer.isView(e)?new DataView(e.buffer,e.byteOffset,e.byteLength):new DataView(e),this.i=null!=t?t:0}$peek(){return this._$dataView.getUint8(this.i)}$skip(){this.i++}$readUint8(){return this._$dataView.getUint8(this.i++)}$readUint16(){const e=this._$dataView.getUint16(this.i);return this.i+=2,e}$readUint32(){const e=this._$dataView.getUint32(this.i);return this.i+=4,e}$readInt8(){return this._$dataView.getInt8(this.i++)}$readInt16(){const e=this._$dataView.getInt16(this.i,!0);return this.i+=2,e}$readInt32(){const e=this._$dataView.getInt32(this.i,!0);return this.i+=4,e}$readFloat32(){const e=this._$dataView.getFloat32(this.i,!0);return this.i+=4,e}$readFloat64(){const e=this._$dataView.getFloat64(this.i,!0);return this.i+=8,e}$readBytes(e){if(this._$dataView.byteOffset+this.i+e>this._$dataView.byteLength)throw new RangeError("exceeded bytes");const t=new Uint8Array(this._$dataView.buffer,this._$dataView.byteOffset+this.i,e);return this.i+=e,t}}var E;exports.Type=void 0,(E=exports.Type||(exports.Type={}))[E.UInt=0]="UInt",E[E.UInt8=1]="UInt8",E[E.UInt16=2]="UInt16",E[E.UInt32=3]="UInt32",E[E.Int=4]="Int",E[E.Int8=5]="Int8",E[E.Int16=6]="Int16",E[E.Int32=7]="Int32",E[E.Float64=8]="Float64",E[E.Float32=9]="Float32",E[E.Float16=10]="Float16",E[E.Scalar8=11]="Scalar8",E[E.UScalar8=12]="UScalar8",E[E.Bool=13]="Bool",E[E.Bools=14]="Bools",E[E.Buffer=15]="Buffer",E[E.String=16]="String",E[E.JSON=17]="JSON",E[E.RegExp=18]="RegExp",E[E.Date=19]="Date";class MaybeType{constructor(e){this.type=e}}class BufferFormat{get encodingBuffer(){var e;return null===(e=this._$writer)||void 0===e?void 0:e._$dataView}constructor(e,t){if(this._$hasValidationOrTransforms=!1,"number"==typeof e)this._$type=e;else{if(e instanceof MaybeType)throw new TypeError("Format cannot be optional");if(!(e instanceof Object))throw new TypeError("Format must be object or Type");if(this._$type=void 0,this._$fieldsMap=new Map,this._$fields=Object.keys(e).map((t=>{const r=new Field(t,e[t]);return this._$fieldsMap.set(t,r),r})),void 0===t)this.header=$hashCode(this.f),this._$header=this.header;else if(null===t)this.header=void 0,this._$header=void 0;else{if(!function isValidHeader(e){return"number"==typeof e?Number.isInteger(e)&&e>=0&&e<=65535:"string"==typeof e&&2===(new TextEncoder).encode(e).byteLength}(t))throw new TypeError(`Header must be uint16, 2 byte string, or null. Received: ${t}`);this.header=t,this._$header="number"==typeof t?t:$strToHashCode(t)}}}get f(){return void 0===this._$format&&(this._$format=void 0!==this._$fields?`{${this._$fields.map((e=>e.f)).join(",")}}`:`${this._$type}`),this._$format}static _$initWriter(){return S.useGlobalEncodingBuffer?(BufferFormat._$globalWriter||(this._$globalWriter=new BufferWriter(S.encodingBufferInitialSize)),this._$globalWriter):new BufferWriter(S.encodingBufferInitialSize)}encode(e,t){return this._$writer||(this._$writer=BufferFormat._$initWriter()),this._$writer.i=0,this._$hasValidationOrTransforms&&(e=this._$preprocess(e)),this._$write(e,this._$writer),(null!=t?t:S.safe)?this._$writer.$copyBytes():this._$writer.$viewBytes()}decode(e){return this._$read(new BufferReader(e,void 0===this.header?0:2))}setTransforms(e){if(this._$hasValidationOrTransforms=!0,"function"==typeof e||Array.isArray(e)&&"function"==typeof e[0])this._$transforms=e;else for(const t of Object.keys(e)){const r=this._$fieldsMap.get(t);if(!r)throw new TypeError(`Failed to set transforms for field '${t}'`);r.$coder.setTransforms(e[t])}return this}setValidation(e){if(this._$hasValidationOrTransforms=!0,"function"==typeof e)this._$validate=e;else for(const t of Object.keys(e)){const r=this._$fieldsMap.get(t);if(!r)throw new TypeError(`Failed to set validation function for field '${t}'`);r.$coder.setValidation(e[t])}return this}_$write(e,t){if(void 0!==this._$header&&t.$writeUint16(this._$header),void 0!==this._$type){const r=this._$validate||this._$transforms?this._$preprocess(e):e;return I[this._$type](r,t)}if("object"!=typeof e||!e)throw new TypeError("expected object type");for(const r of this._$fields){const i=e[r.$name];if(r.$isOptional){if(null==i){B.$write(!1,t);continue}B.$write(!0,t)}else if(null==i)throw new Error(`missing required value: ${r.$name}`);r.$isArray?this._$writeArray(i,t,r.$coder):r.$coder._$write(i,t)}}_$preprocess(e){return this._$validate&&this._$processValidation(e),"function"==typeof this._$transforms?this._$transforms(e):Array.isArray(this._$transforms)&&"function"==typeof this._$transforms[0]?this._$transforms[0](e):e}_$postprocess(e){return Array.isArray(this._$transforms)&&"function"==typeof this._$transforms[1]&&(e=this._$transforms[1](e)),this._$validate&&this._$processValidation(e),e}_$processValidation(e){if(!this._$validate)return;const t=this._$validate(e);if(t instanceof Error)throw t;if(!1===t)throw new Error("failed validation")}_$read(e){return this._$read=this._$compileFormatReadFn(),this._$read(e)}_$makeObjectReader(){return`return{${this._$fields.map((({$name:e},t)=>`${e}:this.${this._$readField.name}(${t},state)`)).join(",")}}`}_$readField(e,t){const r=this._$fields[e];if(!r.$isOptional||B.$read(t))return r.$isArray?this._$readArray(r.$coder,t):r.$coder._$read(t)}_$compileFormatReadFn(){return void 0!==this._$type?this._$hasValidationOrTransforms?e=>this._$postprocess(x[this._$type](e)):x[this._$type]:new Function("state",this._$makeObjectReader())}_$writeArray(e,t,r){if(!Array.isArray(e))throw new TypeError(`expected array, instead got: ${e}`);$.$write(e.length,t);for(let i=0;i<e.length;i++)r._$write(e[i],t)}_$readArray(e,t){const r=new Array($.$read(t));for(let i=0;i<r.length;i++)r[i]=e._$read(t);return r}}BufferFormat.peekHeader=peekHeader,BufferFormat.peekHeaderStr=peekHeaderStr;class Field{constructor(e,t){this.$isOptional=t instanceof MaybeType;let r=t instanceof MaybeType?t.type:t;if(this.$name=e,Array.isArray(r)){if(1!==r.length)throw new TypeError("Array type must contain exactly one format");r=r[0],this.$isArray=!0}else this.$isArray=!1;this.$coder=new BufferFormat(r,null)}get f(){return void 0===this._$formatString&&(this._$formatString=`${this.$coder.f}${this.$isArray?"[]":""}${this.$isOptional?"?":""}`),this._$formatString}}exports.TinybufError=TinybufError,exports.bufferParser=()=>new BufferParser,exports.defineFormat=function defineFormat(e,t){return null!==e&&"object"==typeof e?new BufferFormat(e):new BufferFormat(t,e)},exports.f16round=function f16round(e){return n(a(e))},exports.mask=mask,exports.optional=function optional(e){return new MaybeType(e)},exports.peekHeader=peekHeader,exports.peekHeaderStr=peekHeaderStr,exports.scalround=function scalround(e){return $fromscal8($toscal8(e))},exports.setTinybufConfig=e=>{S=Object.assign(Object.assign({},S),e)},exports.unmask=unmask,exports.uscalround=function uscalround(e){return $fromuscal8($touscal8(e))};
//# sourceMappingURL=index.cjs.map
