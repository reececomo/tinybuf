"use strict";class TinyBufError extends Error{}class UnrecognizedFormatError extends TinyBufError{}class FormatHeaderCollisionError extends TinyBufError{}class BufferDecodingError extends TinyBufError{constructor(e,t){super(`${e}: ${t.message}`),this.underlying=t,this.stack=t.stack}}class WriteTypeError extends TinyBufError{constructor(e,t,r){super(`Expected '${e}', instead received: ${t} (type: ${typeof t}) (at path: '${r||"<root>"}')`)}}class BufferEncodingError extends TinyBufError{}function djb2HashUInt16(e){let t=5381;for(let r=0;r<e.length;r++)t=33*t^e.charCodeAt(r);return 65535&t}const e=djb2HashUInt16;function strToHashCode(e){return 2===e.length?256*e.charCodeAt(0)+e.charCodeAt(1):djb2HashUInt16(e)}function hashCodeToStr(e){return String.fromCharCode(Math.floor(e/256))+String.fromCharCode(e%256)}function peekHeader(e){return new DataView(e instanceof ArrayBuffer?e:e.buffer).getUint16(0,!1)}function peekHeaderStr(e){return hashCodeToStr(peekHeader(e))}class BufferParserInstance{constructor(){this.formats=new Map}get availableFormats(){return new Set([...this.formats.values()].map((e=>e[0])))}processBuffer(e){let t;try{t=peekHeader(e)}catch(e){throw new BufferDecodingError("Failed to process buffer",e)}if(!this.formats.has(t))throw new UnrecognizedFormatError(`Unrecognized format (uint16: ${t}, str: '${hashCodeToStr(t)}')`);const[r,n]=this.formats.get(t);let i;try{i=r.decode(e)}catch(e){throw new BufferDecodingError(`Failed to decode data to format '${r.header}'`,e)}n(i)}on(e,t,r=!1){if(null==e.header)throw new TypeError("Cannot register a headerless encoding format.");const n="string"==typeof e.header?strToHashCode(e.header):e.header;if(this.formats.has(n)&&!r)throw new FormatHeaderCollisionError(`Format with identical header was already registered: ${e.header}`);return this.formats.set(n,[e,t]),this}ignore(...e){return e.forEach((e=>this.on(e,(()=>{}),!0))),this}clear(){this.formats.clear()}}function isBooleanArray(e){return Array.isArray(e)&&e.every((e=>"boolean"==typeof e))}function fixedLengthBooleanArrayToBitmask(e,t){let r="";for(let n=0;n<t;n++)r+=+!!e[n];return parseInt(r,2)}function bools2Mask(e){let t="";for(let r=0;r<e.length;r++)t+=+!!e[r];return parseInt(t,2)}function mask2Bools(e,t){return[...(e>>>0).toString(2).padStart(t,"0")].map((e=>"0"!=e))}function clamp(e,t,r){return Math.min(Math.max(e,t),r)}function r2z(e){return e<0?Math.ceil(e):Math.floor(e)}function raz(e){return e<0?Math.floor(e):Math.ceil(e)}function toUScalar8(e){return Number.isNaN(e)?255:clamp(127+r2z(254*e-127),0,254)}function toScalar8(e){return Number.isNaN(e)?255:clamp(r2z(127*e),-127,127)+127}function fromUScalar8(e){return 255===e?NaN:clamp(.01*(raz(.3937007874015748*(e-127))+50),0,1)}function fromScalar8(e){return 255===e?NaN:clamp(.01*raz(.787401574803149*(e-127)),-1,1)}const t=268435456,r=2147483647,n=4294967296,i=new TextDecoder("utf-8"),o={write:function(e,t,r){if("number"!=typeof e||e>Number.MAX_SAFE_INTEGER||e<0)throw new WriteTypeError("uint",e,r);const i=r2z(e);i<128?t.writeUInt8(i):i<16384?t.writeUInt16(i+32768):i<536870912?t.writeUInt32(i+3221225472):(t.writeUInt32(Math.floor(i/n)+3758096384),t.writeUInt32(i>>>0))},read:function(e){const t=e.peekUInt8();return 128&t?64&t?32&t?(e.readUint32()-3758096384)*n+e.readUint32():e.readUint32()-3221225472:e.readUint16()-32768:(e.skipByte(),t)}},a={write:function(e,t,r){if("number"!=typeof e||e<0||e>255)throw new WriteTypeError("uint8",e,r);t.writeUInt8(r2z(e))},read:function(e){return e.readUint8()}},s={write:function(e,t,r){if("number"!=typeof e||e<0||e>65535)throw new WriteTypeError("uint16",e,r);t.writeUInt16(r2z(e))},read:function(e){return e.readUint16()}},f={write:function(e,t,r){if("number"!=typeof e||e<0||e>4294967295)throw new WriteTypeError("uint32",e,r);t.writeUInt32(r2z(e))},read:function(e){return e.readUint32()}},u={write:function(e,r,i){if("number"!=typeof e||e>Number.MAX_SAFE_INTEGER||e<-Number.MAX_SAFE_INTEGER)throw new WriteTypeError("int",e,i);const o=r2z(e);o>=-64&&o<64?r.writeUInt8(127&o):o>=-8192&&o<8192?r.writeUInt16(32768+(16383&o)):o>=-268435456&&o<t?r.writeUInt32(3221225472+(536870911&o)):(r.writeUInt32(3758096384+(536870911&Math.floor(o/n))),r.writeUInt32(o>>>0))},read:function(e){let t,r=e.peekUInt8();return 128&r?64&r?32&r?(t=e.readUint32()-3758096384,t=268435456&t?3758096384|t:t,t*n+e.readUint32()):(t=e.readUint32()-3221225472,268435456&t?3758096384|t:t):(t=e.readUint16()-32768,8192&t?4294950912|t:t):(e.skipByte(),64&r?4294967168|r:r)}},c={write:function(e,t,r){if("number"!=typeof e||e<-127||e>127)throw new WriteTypeError("int8",e,r);t.writeInt8(r2z(e))},read:function(e){return e.readInt8()}},h={write:function(e,t,r){if("number"!=typeof e||e<-32767||e>32767)throw new WriteTypeError("int16",e,r);t.writeInt16(r2z(e))},read:function(e){return e.readInt16()}},d={write:function(e,t,n){if("number"!=typeof e||e<-r||e>r)throw new WriteTypeError("int32",e,n);t.writeInt32(r2z(e))},read:function(e){return e.readInt32()}},l={write:function(e,t,r){if("number"!=typeof e)throw new WriteTypeError("number",e,r);t.writeFloat16(e)},read:function(e){return e.readFloat16()}},w={write:function(e,t,r){if("number"!=typeof e)throw new WriteTypeError("number",e,r);t.writeFloat32(e)},read:function(e){return e.readFloat32()}},p={write:function(e,t,r){if("number"!=typeof e)throw new WriteTypeError("number",e,r);t.writeFloat64(e)},read:function(e){return e.readFloat64()}},y={write:function(e,t,r){if("number"!=typeof e)throw new WriteTypeError("number",e,r);t.writeUInt8(toUScalar8(e))},read:function(e){return fromUScalar8(e.readUint8())}},m={write:function(e,t,r){if("number"!=typeof e)throw new WriteTypeError("number",e,r);t.writeUInt8(toScalar8(e))},read:function(e){return fromScalar8(e.readUint8())}},b={write:function(e,t,r){g.write((new TextEncoder).encode(null!=e?e:""),t,r)},read:function(e){return i.decode(g.read(e))}},g={write:function(e,t,r){o.write(e.byteLength,t,r),t.writeBuffer(e)},read:function(e){return e.readBuffer(o.read(e))}},E={write:function(e,t,r){if("boolean"!=typeof e)throw new WriteTypeError("boolean",e,r);t.writeUInt8(e?1:0)},read:function(e){const t=e.readUint8();return Boolean(0!==t)}},B={write:function(e,t,r){if(!isBooleanArray(e))throw new WriteTypeError("boolean[]",e,r);for(let r=0;r<Math.max(1,e.length);r+=6){const n=bools2Mask([!0,r+6>=e.length,...e.slice(r,r+6)]);t.writeUInt8(n)}},read:function(e){const t=[];let r=!1;for(;!r;){const n=e.readUint8(),i=[...(n>>>0).toString(2)].map((e=>"0"!=e));i.shift(),r=i.shift(),t.push(...i)}return t}},U={write:function(e,t,r){if(!isBooleanArray(e))throw new WriteTypeError("boolean[]",e,r);const n=fixedLengthBooleanArrayToBitmask(e,8);t.writeUInt8(n)},read:function(e){return mask2Bools(e.readUint8(),8)}},T={write:function(e,t,r){if(!isBooleanArray(e))throw new WriteTypeError("boolean[]",e,r);const n=fixedLengthBooleanArrayToBitmask(e,16);t.writeUInt16(n)},read:function(e){return mask2Bools(e.readUint16(),16)}},I={write:function(e,t,r){if(!isBooleanArray(e))throw new WriteTypeError("boolean[]",e,r);const n=fixedLengthBooleanArrayToBitmask(e,32);t.writeUInt32(n)},read:function(e){return mask2Bools(e.readUint32(),32)}},_={write:function(e,t,r){let n;try{n=JSON.stringify(e)}catch(e){throw new WriteTypeError("JSON",e,r)}b.write(n,t,r)},read:function(e){const t=b.read(e);return JSON.parse(t)}},F={write:function(e,t,r){if(!(e instanceof RegExp))throw new WriteTypeError("RegExp",e,r);let n,i,o;b.write(e.source,t,r),n=e.global?1:0,i=e.ignoreCase?2:0,o=e.multiline?4:0,t.writeUInt8(n+i+o)},read:function(e){const t=b.read(e),r=e.readUint8();return new RegExp(t,(1&r?"g":"")+(2&r?"i":"")+(4&r?"m":""))}},A={write:function(e,t,r){if(!(e instanceof Date))throw new WriteTypeError("Date",e,r);{const n=e.getTime();if(isNaN(n))throw new WriteTypeError("Date","NaN",r);u.write(n,t,r)}},read:function(e){return new Date(u.read(e))}};let x={useGlobalEncodingBuffer:!1,encodingBufferMaxSize:1500,encodingBufferInitialSize:256,encodingBufferIncrement:256,debug:!1};var v;const S=Math.pow(2,-24),k=function(){const e=new Float32Array(1),t=new Int32Array(e.buffer);return function toHalf(r){e[0]=r;const n=t[0];let i=n>>16&32768,o=n>>12&2047;const a=n>>23&255;return a<103?i:a>142?isNaN(r)?31745:(i|=31744,i|=(255==a?0:1)&&8388607&n,i):a<113?(o|=2048,i|=(o>>114-a)+(o>>113-a&1),i):(i|=a-112<<10|o>>1,i+=1&o,i)}}();function f16unmask(e){return 32768&e?-f16.t[((e>>10&31)<<10)+(1023&e)]:f16.t[((e>>10&31)<<10)+(1023&e)]}class f16{static _initFloat16LookupTable(){const e=[];for(let t=0;t<32;t++)for(let r=0;r<1024;r++){const n=f16.precalc(t,r);e[(t<<10)+r]=n}return e}static precalc(e,t){return 0===e?0===t?0:S*(t/1024):31===e?0===t?1/0:NaN:(e-=15,Math.pow(2,e)*(1+t/1024))}}v=f16,f16.t=v._initFloat16LookupTable();class BufferWriter{constructor(e){this.o=0,this.resize=!0,e instanceof ArrayBuffer?(this.buf=e,this.resize=!1,x.debug&&console.debug("[tinybuf] assigning buffer writer to global encoding buffer")):(x.debug&&console.debug(`[tinybuf] allocating new buffer (${e} bytes)`),this.buf=new ArrayBuffer(e)),this.view=new DataView(this.buf,0,this.buf.byteLength)}asView(){return new Uint8Array(this.view.buffer,0,this.o)}asCopy(){return new Uint8Array(this.view.buffer.slice(0,this.o))}writeInt8(e){this.view.setInt8(this.alloc(1),e)}writeInt16(e){this.view.setInt16(this.alloc(2),e,!0)}writeInt32(e){this.view.setInt32(this.alloc(4),e,!0)}writeUInt8(e){this.view.setUint8(this.alloc(1),e)}writeUInt16(e){this.view.setUint16(this.alloc(2),e)}writeUInt32(e){this.view.setUint32(this.alloc(4),e)}writeFloat16(e){this.view.setUint16(this.alloc(2),k(e))}writeFloat32(e){this.view.setFloat32(this.alloc(4),e)}writeFloat64(e){this.view.setFloat64(this.alloc(8),e)}writeBuffer(e){const t=this.alloc(e.byteLength),r=e instanceof Uint8Array?e:e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e.buffer,e.byteOffset,e.byteLength);new Uint8Array(this.view.buffer,t,e.byteLength).set(r)}alloc(e){const t=this.o;if(this.o+e<=this.view.byteLength)return this.o+=e,t;if(!this.resize)throw new BufferEncodingError("Write buffer exceeded maximum size of global buffer.");const r=this.view.byteLength,n=r+e;if(n>x.encodingBufferMaxSize)throw new BufferEncodingError(`Write buffer exceeded maximum size. Bytes requested: ${n}. Max size: ${x.encodingBufferMaxSize}.`);let i=this.view.byteLength;do{i=Math.min(i+x.encodingBufferIncrement,x.encodingBufferMaxSize)}while(i<this.o+e);x.debug&&console.debug(`[tinybuf] resizing buffer ${r} -> ${i}`);const o=new ArrayBuffer(i),a=new Uint8Array(this.view.buffer,this.view.byteOffset,r);return new Uint8Array(o).set(a),this.buf=o,this.view=new DataView(o),this.o+=e,t}}class BufferReader{constructor(e,t){this.data=e instanceof ArrayBuffer?new DataView(e):new DataView(e.buffer,e.byteOffset,e.byteLength),this.i=null!=t?t:0}get hasEnded(){return this.i===this.data.byteLength}peekUInt8(){return this.data.getUint8(this.i)}skipByte(){this.i++}readUint8(){return this.data.getUint8(this.i++)}readUint16(){const e=this.data.getUint16(this.i);return this.i+=2,e}readUint32(){const e=this.data.getUint32(this.i);return this.i+=4,e}readInt8(){return this.data.getInt8(this.i++)}readInt16(){const e=this.data.getInt16(this.i,!0);return this.i+=2,e}readInt32(){const e=this.data.getInt32(this.i,!0);return this.i+=4,e}readFloat16(){const e=this.data.getUint16(this.i);return this.i+=2,f16unmask(e)}readFloat32(){const e=this.data.getFloat32(this.i);return this.i+=4,e}readFloat64(){const e=this.data.getFloat64(this.i);return this.i+=8,e}readBuffer(e){if(this.i+e>this.data.byteLength)throw new RangeError("Trying to access beyond byte length");const t=new Uint8Array(this.data.buffer,this.i,e);return this.i+=e,t}}const z=["float16","float32","float64","int","int8","int16","int32","uint","uint8","uint16","uint32","uscalar","scalar","bool","booltuple","bitmask8","bitmask16","bitmask32","str","date","regex","json","buf"];class OptionalType{constructor(e){this.type=e}}class BufferFormat{constructor(e,t){if(this._vt=!1,e instanceof OptionalType)throw new TypeError("Invalid encoding format: Root object cannot be optionals.");if(void 0!==e&&"string"==typeof e&&z.includes(e))this.type=e;else{if(!(e instanceof Object))throw new TypeError("Invalid encoding format: Must be an object, or a known coder type.");this.type="{object}",this.fieldsMap=new Map,this.fields=Object.keys(e).map((t=>{const r=new Field(t,e[t]);return this.fieldsMap.set(t,r),r}))}if(void 0===t&&"{object}"===this.type)this.header=this.hashCode,this._header=this.header;else if(null===t)this.header=void 0,this._header=void 0;else{if(!function isValidHeader(e){return"number"==typeof e?Number.isInteger(e)&&e>=0&&e<=65535:"string"==typeof e&&2===(new TextEncoder).encode(e).byteLength}(t))throw new TypeError(`Header should be an integer between 0 and 65535, a 2-byte string, or null. Received: ${t}`);this.header=t,this._header="number"==typeof t?t:strToHashCode(t)}}get hashCode(){return void 0===this._hash&&(this._hash=e(this.format)),this._hash}get format(){return void 0===this._format&&(this._format="{object}"===this.type?`{${this.fields.map((e=>e.format)).join(",")}}`:`${this.type}`),this._format}encode(e,t){return void 0===this._w?(x.useGlobalEncodingBuffer&&void 0===BufferFormat.globalBuffer&&(BufferFormat.globalBuffer=new ArrayBuffer(x.encodingBufferMaxSize),x.debug&&console.debug(`[tinybuf] init global encoding buffer (${x.encodingBufferMaxSize} bytes)`)),this._w=new BufferWriter(x.useGlobalEncodingBuffer?BufferFormat.globalBuffer:x.encodingBufferInitialSize)):this._w.o=0,this._vt&&(e=this._preEncode(e)),this.write(e,this._w,""),(null==t?void 0:t.safe)?this._w.asCopy():this._w.asView()}decode(e){return this.read(new BufferReader(e,void 0===this.header?0:2))}setTransforms(e){if(this._vt=!0,e instanceof Function||Array.isArray(e)&&e[0]instanceof Function)this._transforms=e;else for(const t of Object.keys(e)){const r=this.fieldsMap.get(t);if(!r)throw new TypeError(`Failed to set transforms for field '${t}'`);r.coder.setTransforms(e[t])}return this}setValidation(e){if(this._vt=!0,e instanceof Function)this._validate=e;else for(const t of Object.keys(e)){const r=this.fieldsMap.get(t);if(!r)throw new TypeError(`Failed to set validation function for field '${t}'`);r.coder.setValidation(e[t])}return this}write(e,t,r){if(void 0!==this._header&&this._w.writeUInt16(this._header),"{object}"!==this.type){const n=this._validate||this._transforms?this._preEncode(e):e;return this.getCoder(this.type).write(n,t,r)}if(!e||"object"!=typeof e)throw new TypeError(`Expected an object at ${r}`);for(const n of this.fields){const i=r?`${r}.${n.name}`:n.name,o=e[n.name];if(n.isOptional){if(null==o){E.write(!1,t);continue}E.write(!0,t)}n.isArray?this._writeArray(o,t,i,n.coder):n.coder.write(o,t,i)}}getCoder(e){switch(e){case"bool":return E;case"booltuple":return B;case"bitmask16":return T;case"bitmask32":return I;case"bitmask8":return U;case"buf":return g;case"date":return A;case"float16":return l;case"float32":return w;case"float64":return p;case"int":return u;case"int16":return h;case"int32":return d;case"int8":return c;case"json":return _;case"regex":return F;case"scalar":return m;case"str":return b;case"uint":return o;case"uint16":return s;case"uint32":return f;case"uint8":return a;case"uscalar":return y}}_preEncode(e){if(this._validate&&!1===this._validate(e))throw new Error("custom validation failed");return this._transforms instanceof Function?this._transforms(e):Array.isArray(this._transforms)&&this._transforms[0]instanceof Function?this._transforms[0](e):e}_postDecode(e){return Array.isArray(this._transforms)&&this._transforms[1]instanceof Function&&(e=this._transforms[1](e)),this._validate instanceof Function&&this._validate(e),e}read(e){return this.read=this.compileRead(),this.read(e)}generateObjectReadCode(){return`return{${this.fields.map((({name:e},t)=>`${e}:this.${this._readField.name}(${t},state)`)).join(",")}}`}_readField(e,t){const r=this.fields[e];if(!r.isOptional||this._readOptional(t))return r.isArray?this._readArray(r.coder,t):r.coder.read(t)}readValueType(e){return this._postDecode(this.getCoder(this.type).read(e))}compileRead(){if("{object}"!==this.type&&"[array]"!==this.type)return void 0!==this._validate||void 0!==this._transforms?this.readValueType:this.getCoder(this.type).read;const e=this.generateObjectReadCode();return new Function("state",e)}_writeArray(e,t,r,n){let i,a;if(!Array.isArray(e))throw new WriteTypeError(`Array<${n.type}>`,t,r);for(a=e.length,o.write(a,t),i=0;i<a;i++)n.write(e[i],t,r+"."+i)}_readArray(e,t){const r=new Array(o.read(t));for(let n=0;n<r.length;n++)r[n]=e.read(t);return r}_readOptional(e){return E.read(e)}}BufferFormat.peekHeader=peekHeader,BufferFormat.peekHeaderStr=peekHeaderStr;class Field{constructor(e,t){this.isOptional=t instanceof OptionalType;let r=t instanceof OptionalType?t.type:t;if(this.name=e,Array.isArray(r)){if(1!==r.length)throw new TypeError("Invalid array definition, it must have exactly one element");r=r[0],this.isArray=!0}else this.isArray=!1;this.coder=new BufferFormat(r,null)}get format(){return void 0===this._format&&(this._format=`${this.coder.format}${this.isArray?"[]":""}${this.isOptional?"?":""}`),this._format}}exports.BufferDecodingError=BufferDecodingError,exports.BufferEncodingError=BufferEncodingError,exports.BufferFormat=BufferFormat,exports.BufferParserInstance=BufferParserInstance,exports.FormatHeaderCollisionError=FormatHeaderCollisionError,exports.TinyBufError=TinyBufError,exports.UnrecognizedFormatError=UnrecognizedFormatError,exports.WriteTypeError=WriteTypeError,exports.bufferParser=()=>new BufferParserInstance,exports.defineFormat=function defineFormat(e,t){return null!==e&&"object"==typeof e?new BufferFormat(e):new BufferFormat(t,e)},exports.f16mask=k,exports.f16unmask=f16unmask,exports.fromScalar8=fromScalar8,exports.fromUScalar8=fromUScalar8,exports.fround16=function fround16(e){return f16unmask(k(e))},exports.optional=function optional(e){return new OptionalType(e)},exports.peekHeader=peekHeader,exports.peekHeaderStr=peekHeaderStr,exports.scalarRound=function scalarRound(e){return fromScalar8(toScalar8(e))},exports.setTinybufConfig=e=>{x=Object.assign(Object.assign({},x),e)},exports.toScalar8=toScalar8,exports.toUScalar8=toUScalar8,exports.uScalarRound=function uScalarRound(e){return fromUScalar8(toUScalar8(e))};
//# sourceMappingURL=index.cjs.map
