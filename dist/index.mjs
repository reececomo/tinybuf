class TinybufError extends Error{}function $hashCode(t){let e=5381;for(let r=0;r<t.length;r++)e=33*e^t.charCodeAt(r);return 65535&e}function $strToHashCode(t){return 2!==t.length?$hashCode(t):256*t.charCodeAt(0)+t.charCodeAt(1)}function $hashCodeToStr(t){return String.fromCharCode(Math.floor(t/256))+String.fromCharCode(t%256)}function peekHeader(t){return(ArrayBuffer.isView(t)?new DataView(t.buffer,t.byteOffset,2):new DataView(t,0,2)).getUint16(0,!1)}function peekHeaderStr(t){return $hashCodeToStr(peekHeader(t))}const bufferParser=()=>new BufferParser;class BufferParser{constructor(){this.t=new Map}processBuffer(t){let e,r,i;try{const n=peekHeader(t);if(!this.t.has(n))throw new TinybufError(`Unknown format: ${n} '${$hashCodeToStr(n)}')`);[e,i]=this.t.get(n),r=e.decode(t)}catch(t){const e=new TinybufError(`Failed to decode: ${t}`);throw e.stack=t.stack,e}i(r)}on(t,e,r=!1){if(null==t.header)throw new TinybufError("Format requires header");const i="string"==typeof t.header?$strToHashCode(t.header):t.header;if(this.t.has(i)&&!r)throw new TinybufError(`Format header collision: ${t.header}`);return this.t.set(i,[t,e]),this}ignore(...t){return t.forEach((t=>this.on(t,(()=>{}),!0))),this}clear(){this.t.clear()}}const t=Math.floor,e=Math.ceil,$clamp=(t,e,r)=>t>r?r:t<e?e:t,$roundTowardZero=r=>r<0?e(r):t(r),$roundAwayFromZero=r=>r<0?t(r):e(r);function uscalround(t){return $fromuscal8($touscal8(t))}function scalround(t){return $fromscal8($toscal8(t))}function $touscal8(t){return $clamp(127+$roundTowardZero(254*t-127),0,254)}function $toscal8(t){return $clamp($roundTowardZero(127*t),-127,127)+127}function $fromuscal8(t){return $clamp(.01*($roundAwayFromZero(.3937007874015748*(t-127))+50),0,1)}function $fromscal8(t){return $clamp(.01*$roundAwayFromZero(.787401574803149*(t-127)),-1,1)}const mask=(t,e=1)=>t.reduce(((t,e)=>t<<1|e),e),unmask=(t,e=31-Math.clz32(t))=>{const r=new Array(e);for(let i=0;i<e;i++)r[i]=!!(t&1<<e-1-i);return r},r=new TextEncoder,i=new TextDecoder("utf-8");function f16round(t){return s(n(t))}const n=function(){const t=new Float32Array(1),e=new Int32Array(t.buffer);return function(r){t[0]=r;let i=e[0],n=i>>16&32768,s=4096+(2147483647&i)|0;return s>=1199570944?(2147483647&i)<1199570944?31743|n:s<2139095040?31744|n:31744|n|(8388607&i)>>13:s>=947912704?n|s-939524096>>13:s<855638016?n:(s=(2147483647&i)>>23,n|(8388607&i|8388608)+(8388608>>>s-102)>>126-s)}}(),s=function(){const t=Math.pow(2,-24),e=new Float32Array(1056);for(let t=0;t<32;t++)e[t]=Math.pow(2,t-15);for(let t=0;t<1024;t++)e[t+32]=1+t/1024;return function(r){const i=32768&~r?1:-1,n=31744&r,s=1023&r;return 0===n?0===s?0*i:i*t:31744===n?0===s?i*(1/0):NaN:e[n>>10]*e[s+32]*i}}(),o=268435456,h=4294967296,a={o:(e,r)=>{e<128?r.h(e):e<16384?r.u(e+32768):e<536870912?r.$(e+3221225472):(r.$(t(e/h)+3758096384),r.$(e>>>0))},l:t=>{const e=t.p();return 128&e?64&e?32&e?(t.m()-3758096384)*h+t.m():t.m()-3221225472:t.B()-32768:(t.T(),e)}},f={o:(t,e)=>e.h(t),l:t=>t.F()},u={o:(t,e)=>e.u(t),l:t=>t.B()},c={o:(t,e)=>e.$(t),l:t=>t.m()},d={o:(e,r)=>{if(e>=-64&&e<64)r.h(127&e);else if(e>=-8192&&e<8192)r.u(32768+(16383&e));else if(e>=-268435456&&e<o)r.$(3221225472+(536870911&e));else{const i=e;r.$(3758096384+(536870911&t(i/h))),r.$(i>>>0)}},l:t=>{let e,r=t.p();return 128&r?64&r?32&r?(e=t.m()-3758096384,e=268435456&e?3758096384|e:e,e*h+t.m()):(e=t.m()-3221225472,268435456&e?3758096384|e:e):(e=t.B()-32768,8192&e?4294950912|e:e):(t.T(),64&r?4294967168|r:r)}},$={o:(t,e)=>e.A(t),l:t=>t.v()},l={o:(t,e)=>e.U(t),l:t=>t.O()},w={o:(t,e)=>e.H(t),l:t=>t.S()},y={o:(t,e)=>e.u(n(t)),l:t=>s(t.B())},p={o:(t,e)=>e._(t),l:t=>t.k()},m={o:(t,e)=>e.j(t),l:t=>t.M()},B={o:(t,e)=>e.h($touscal8(t)),l:t=>$fromuscal8(t.F())},b={o:(t,e)=>e.h($toscal8(t)),l:t=>$fromscal8(t.F())},T={o:(t,e)=>d.o(t.getTime(),e),l:t=>new Date(d.l(t))},F={o:(t,e)=>{return A.o((i=null!=t?t:"",r.encode(i)),e);var i},l:t=>{return e=A.l(t),i.decode(e);var e}},A={o:(t,e)=>{a.o(t.byteLength,e),e.I(t)},l:t=>t.C(a.l(t))},v={o:(t,e)=>e.h(t?1:0),l:t=>0!==t.F()},E={o:(t,e)=>{t.length>28&&(t=t.slice(0,28)),a.o(mask(t),e)},l:t=>unmask(a.l(t))},g={o:(t,e)=>F.o(JSON.stringify(t),e),l:t=>JSON.parse(F.l(t))},U={o:(t,e)=>{e.h(mask([t.global,t.ignoreCase,t.multiline])),F.o(t.source,e)},l:t=>{const[e,r,i]=unmask(t.F());return new RegExp(F.l(t),(e?"g":"")+(r?"i":"")+(i?"m":""))}},O=[a.o,f.o,u.o,c.o,d.o,$.o,l.o,w.o,m.o,p.o,y.o,b.o,B.o,v.o,E.o,A.o,F.o,g.o,U.o,T.o],x=[a.l,f.l,u.l,c.l,d.l,$.l,l.l,w.l,m.l,p.l,y.l,b.l,B.l,v.l,E.l,A.l,F.l,g.l,U.l,T.l],setTinybufConfig=t=>{H=Object.assign(Object.assign({},H),t)};let H={safe:!1,useGlobalEncodingBuffer:!0,encodingBufferMaxSize:1500,encodingBufferInitialSize:256,encodingBufferIncrement:256};class BufferWriter{constructor(t){this.i=0,console.debug(`initializing buffer to ${t}`),this.D=new DataView(new ArrayBuffer(t))}V(){return new Uint8Array(this.D.buffer,this.D.byteOffset,this.i)}R(){return new Uint8Array(this.D.buffer.slice(0,this.i))}A(t){this.D.setInt8(this.N(1),t)}U(t){this.D.setInt16(this.N(2),t,!0)}H(t){this.D.setInt32(this.N(4),t,!0)}h(t){this.D.setUint8(this.N(1),t)}u(t){this.D.setUint16(this.N(2),t,!1)}$(t){this.D.setUint32(this.N(4),t,!1)}_(t){this.D.setFloat32(this.N(4),t,!0)}j(t){this.D.setFloat64(this.N(8),t,!0)}I(t){const e=this.N(t.byteLength),r=ArrayBuffer.isView(t)?t instanceof Uint8Array?t:new Uint8Array(t.buffer,t.byteOffset,t.byteLength):new Uint8Array(t);new Uint8Array(this.D.buffer,this.D.byteOffset+e,t.byteLength).set(r)}N(t){if(this.i+t>this.D.byteLength){const e=this.i+t-this.D.byteLength,r=Math.ceil(e/H.encodingBufferIncrement)*H.encodingBufferIncrement;this.W(this.D.byteLength+r)}const e=this.i;return this.i+=t,e}W(t){if(t>H.encodingBufferMaxSize)throw new TinybufError(`exceeded encodingBufferMaxSize: ${H.encodingBufferMaxSize}`);console.debug(`resized buffer from ${this.D.byteLength} to ${t}`);const e=new ArrayBuffer(t),r=new Uint8Array(this.D.buffer,this.D.byteOffset,this.D.byteLength);new Uint8Array(e).set(r),this.D=new DataView(e)}}class BufferReader{constructor(t,e){this.D=ArrayBuffer.isView(t)?new DataView(t.buffer,t.byteOffset,t.byteLength):new DataView(t),this.i=null!=e?e:0}p(){return this.D.getUint8(this.i)}T(){this.i++}F(){return this.D.getUint8(this.i++)}B(){const t=this.D.getUint16(this.i);return this.i+=2,t}m(){const t=this.D.getUint32(this.i);return this.i+=4,t}v(){return this.D.getInt8(this.i++)}O(){const t=this.D.getInt16(this.i,!0);return this.i+=2,t}S(){const t=this.D.getInt32(this.i,!0);return this.i+=4,t}k(){const t=this.D.getFloat32(this.i,!0);return this.i+=4,t}M(){const t=this.D.getFloat64(this.i,!0);return this.i+=8,t}C(t){if(this.D.byteOffset+this.i+t>this.D.byteLength)throw new RangeError("exceeded bytes");const e=new Uint8Array(this.D.buffer,this.D.byteOffset+this.i,t);return this.i+=t,e}}class OptionalType{constructor(t){this.type=t}}function optional(t){return new OptionalType(t)}function defineFormat(t,e){return null!==t&&"object"==typeof t?new BufferFormat(t):new BufferFormat(e,t)}class BufferFormat{get encodingBuffer(){var t;return null===(t=this.J)||void 0===t?void 0:t.D}constructor(t,e){if(this.P=!1,"number"==typeof t)this.q=t;else{if(t instanceof OptionalType)throw new TypeError("Format cannot be optional");if(!(t instanceof Object))throw new TypeError("Format must be object or Type");if(this.q=void 0,this.G=new Map,this.K=Object.keys(t).map((e=>{const r=new Field(e,t[e]);return this.G.set(e,r),r})),void 0===e)this.header=$hashCode(this.f),this.L=this.header;else if(null===e)this.header=void 0,this.L=void 0;else{if(!function isValidHeader(t){return"number"==typeof t?Number.isInteger(t)&&t>=0&&t<=65535:"string"==typeof t&&2===(new TextEncoder).encode(t).byteLength}(e))throw new TypeError(`Header should be an integer between 0 and 65535, a 2-byte string, or null. Received: ${e}`);this.header=e,this.L="number"==typeof e?e:$strToHashCode(e)}}}get f(){return void 0===this.X&&(this.X=void 0!==this.K?`{${this.K.map((t=>t.f)).join(",")}}`:`${this.q}`),this.X}static Y(){return H.useGlobalEncodingBuffer?(BufferFormat.Z||(this.Z=new BufferWriter(H.encodingBufferInitialSize)),this.Z):new BufferWriter(H.encodingBufferInitialSize)}encode(t,e){return this.J||(this.J=BufferFormat.Y()),this.J.i=0,this.P&&(t=this.tt(t)),this.et(t,this.J),(null!=e?e:H.safe)?this.J.R():this.J.V()}decode(t){return this.rt(new BufferReader(t,void 0===this.header?0:2))}setTransforms(t){if(this.P=!0,"function"==typeof t||Array.isArray(t)&&"function"==typeof t[0])this.it=t;else for(const e of Object.keys(t)){const r=this.G.get(e);if(!r)throw new TypeError(`Failed to set transforms for field '${e}'`);r.nt.setTransforms(t[e])}return this}setValidation(t){if(this.P=!0,"function"==typeof t)this.st=t;else for(const e of Object.keys(t)){const r=this.G.get(e);if(!r)throw new TypeError(`Failed to set validation function for field '${e}'`);r.nt.setValidation(t[e])}return this}et(t,e){if(void 0!==this.L&&this.J.u(this.L),void 0!==this.q){const r=this.st||this.it?this.tt(t):t;return O[this.q](r,e)}if(!t||"object"!=typeof t)throw new TypeError("expected object type");for(const r of this.K){const i=t[r.ot];if(r.ht){if(null==i){v.o(!1,e);continue}v.o(!0,e)}r.ft?this.ut(i,e,r.nt):r.nt.et(i,e)}}tt(t){if(this.st&&!1===this.st(t))throw new Error("failed validation");return"function"==typeof this.it?this.it(t):Array.isArray(this.it)&&"function"==typeof this.it[0]?this.it[0](t):t}ct(t){return Array.isArray(this.it)&&"function"==typeof this.it[1]&&(t=this.it[1](t)),void 0!==this.st&&this.st(t),t}rt(t){return this.rt=this.dt(),this.rt(t)}$t(){return`return{${this.K.map((({ot:t},e)=>`${t}:this.${this.lt.name}(${e},state)`)).join(",")}}`}lt(t,e){const r=this.K[t];if(!r.ht||this.wt(e))return r.ft?this.yt(r.nt,e):r.nt.rt(e)}dt(){return void 0!==this.q?this.P?t=>this.ct(x[this.q](t)):x[this.q]:new Function("state",this.$t())}ut(t,e,r){if(!Array.isArray(t))throw new TypeError(`expected array, instead got: ${e}`);a.o(t.length,e);for(let i=0;i<t.length;i++)r.et(t[i],e)}yt(t,e){const r=new Array(a.l(e));for(let i=0;i<r.length;i++)r[i]=t.rt(e);return r}wt(t){return v.l(t)}}BufferFormat.peekHeader=peekHeader,BufferFormat.peekHeaderStr=peekHeaderStr;class Field{constructor(t,e){this.ht=e instanceof OptionalType;let r=e instanceof OptionalType?e.type:e;if(this.ot=t,Array.isArray(r)){if(1!==r.length)throw new TypeError("Invalid array definition, it must have exactly one element");r=r[0],this.ft=!0}else this.ft=!1;this.nt=new BufferFormat(r,null)}get f(){return void 0===this.Bt&&(this.Bt=`${this.nt.f}${this.ft?"[]":""}${this.ht?"?":""}`),this.Bt}}export{TinybufError,bufferParser,defineFormat,f16round,mask,optional,peekHeader,peekHeaderStr,scalround,setTinybufConfig,unmask,uscalround};
//# sourceMappingURL=index.mjs.map
