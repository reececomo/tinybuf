class TinybufError extends Error{}class EncodeError extends TinybufError{constructor(t,r,e){super(`Failed to encode ${r} as '${t}'${e?` (path: '${e}')`:""}`)}}class DecodeError extends TinybufError{constructor(t,r){super(`${t}: ${r.message}`),this.cause=r,this.stack=r.stack}}function $hashCode(t){let r=5381;for(let e=0;e<t.length;e++)r=33*r^t.charCodeAt(e);return 65535&r}function $strToHashCode(t){return 2!==t.length?$hashCode(t):256*t.charCodeAt(0)+t.charCodeAt(1)}function $hashCodeToStr(t){return String.fromCharCode(Math.floor(t/256))+String.fromCharCode(t%256)}function peekHeader(t){return new DataView(t instanceof ArrayBuffer?t:t.buffer).getUint16(0,!1)}function peekHeaderStr(t){return $hashCodeToStr(peekHeader(t))}const bufferParser=()=>new BufferParser;class BufferParser{constructor(){this.t=new Map}processBuffer(t){let r,e,n;try{const i=peekHeader(t);if(!this.t.has(i))throw new TinybufError(`Unknown format: ${i} '${$hashCodeToStr(i)}')`);[r,n]=this.t.get(i),e=r.decode(t)}catch(t){throw new DecodeError("Failed to decode",t)}n(e)}on(t,r,e=!1){if(null==t.header)throw new TinybufError("Format requires header");const n="string"==typeof t.header?$strToHashCode(t.header):t.header;if(this.t.has(n)&&!e)throw new TinybufError(`Format header collision: ${t.header}`);return this.t.set(n,[t,r]),this}ignore(...t){return t.forEach((t=>this.on(t,(()=>{}),!0))),this}clear(){this.t.clear()}}function clamp(t,r,e){return Math.min(Math.max(t,r),e)}function r2z(t){return t<0?Math.ceil(t):Math.floor(t)}function raz(t){return t<0?Math.floor(t):Math.ceil(t)}function toUScalar8(t){return Number.isNaN(t)?255:clamp(127+r2z(254*t-127),0,254)}function toScalar8(t){return Number.isNaN(t)?255:clamp(r2z(127*t),-127,127)+127}function fromUScalar8(t){return 255===t?NaN:clamp(.01*(raz(.3937007874015748*(t-127))+50),0,1)}function fromScalar8(t){return 255===t?NaN:clamp(.01*raz(.787401574803149*(t-127)),-1,1)}function uScalarRound(t){return fromUScalar8(toUScalar8(t))}function scalarRound(t){return fromScalar8(toScalar8(t))}function $bools2Mask(t,r){let e="";for(let n=0;n<r;n++)e+=+!!t[n];return parseInt(e,2)}function $mask2Bools(t,r){return[...(t>>>0).toString(2).padStart(r,"0")].map((t=>"0"!=t))}function $vBools2Mask(t){let r="";for(let e=0;e<t.length;e++)r+=+!!t[e];return parseInt(r,2)}const t=268435456,r=2147483647,e=4294967296,n=new TextDecoder("utf-8"),i={o:function(t,r,n){if("number"!=typeof t||t>Number.MAX_SAFE_INTEGER||t<0)throw new EncodeError("uint",t,n);if(t<128)r.u(r2z(t));else if(t<16384)r.h(r2z(t)+32768);else if(t<536870912)r.l(r2z(t)+3221225472);else{const n=r2z(t);r.l(Math.floor(n/e)+3758096384),r.l(n>>>0)}},$:function(t){const r=t.p();return 128&r?64&r?32&r?(t.m()-3758096384)*e+t.m():t.m()-3221225472:t.B()-32768:(t.F(),r)}},o={o:function(r,n,i){if("number"!=typeof r||r>Number.MAX_SAFE_INTEGER||r<-Number.MAX_SAFE_INTEGER)throw new EncodeError("int",r,i);if(r>=-64&&r<64)n.u(127&r2z(r));else if(r>=-8192&&r<8192)n.h(32768+(16383&r2z(r)));else if(r>=-268435456&&r<t)n.l(3221225472+(536870911&r2z(r)));else{const t=r2z(r);n.l(3758096384+(536870911&Math.floor(t/e))),n.l(t>>>0)}},$:function(t){let r,n=t.p();return 128&n?64&n?32&n?(r=t.m()-3758096384,r=268435456&r?3758096384|r:r,r*e+t.m()):(r=t.m()-3221225472,268435456&r?3758096384|r:r):(r=t.B()-32768,8192&r?4294950912|r:r):(t.F(),64&n?4294967168|n:n)}},s={o:function(t,r,e){a.o((new TextEncoder).encode(null!=t?t:""),r,e)},$:function(t){return n.decode(a.$(t))}},a={o:function(t,r,e){i.o(t.byteLength,r,e),r.T(t)},$:function(t){return t.A(i.$(t))}},f={o:function(t,r){r.u(t?1:0)},$:function(t){return 0!==t.S()}},u={o:function(t,r,e){let n;try{n=JSON.stringify(t)}catch(t){throw new EncodeError("JSON",t,e)}s.o(n,r,e)},$:function(t){const r=s.$(t);return JSON.parse(r)}},c={o:function(t,r,e){if(!(t instanceof RegExp))throw new EncodeError("RegExp",t,e);let n,i,o;s.o(t.source,r,e),n=t.global?1:0,i=t.ignoreCase?2:0,o=t.multiline?4:0,r.u(n+i+o)},$:function(t){const r=s.$(t),e=t.S();return new RegExp(r,(1&e?"g":"")+(2&e?"i":"")+(4&e?"m":""))}},h={o:function(t,r,e){if(!(t instanceof Date))throw new EncodeError("Date",t,e);{const n=t.getTime();if(isNaN(n))throw new EncodeError("Date","NaN",e);o.o(n,r,e)}},$:function(t){return new Date(o.$(t))}},d=[i,{o:function(t,r,e){if("number"!=typeof t||t<0||t>255)throw new EncodeError("uint8",t,e);r.u(r2z(t))},$:function(t){return t.S()}},{o:function(t,r,e){if("number"!=typeof t||t<0||t>65535)throw new EncodeError("uint16",t,e);r.h(r2z(t))},$:function(t){return t.B()}},{o:function(t,r,e){if("number"!=typeof t||t<0||t>4294967295)throw new EncodeError("uint32",t,e);r.l(r2z(t))},$:function(t){return t.m()}},o,{o:function(t,r,e){if("number"!=typeof t||t<-127||t>127)throw new EncodeError("int8",t,e);r.k(r2z(t))},$:function(t){return t.U()}},{o:function(t,r,e){if("number"!=typeof t||t<-32767||t>32767)throw new EncodeError("int16",t,e);r.M(r2z(t))},$:function(t){return t.v()}},{o:function(t,e,n){if("number"!=typeof t||t<-r||t>r)throw new EncodeError("int32",t,n);e.N(r2z(t))},$:function(t){return t.I()}},{o:function(t,r,e){if("number"!=typeof t)throw new EncodeError("number",t,e);r.O(t)},$:function(t){return t.R()}},{o:function(t,r,e){if("number"!=typeof t)throw new EncodeError("number",t,e);r.D(t)},$:function(t){return t.H()}},{o:function(t,r,e){if("number"!=typeof t)throw new EncodeError("number",t,e);r.j(t)},$:function(t){return t._()}},{o:function(t,r,e){if("number"!=typeof t)throw new EncodeError("number",t,e);r.u(toScalar8(t))},$:function(t){return fromScalar8(t.S())}},{o:function(t,r,e){if("number"!=typeof t)throw new EncodeError("number",t,e);r.u(toUScalar8(t))},$:function(t){return fromUScalar8(t.S())}},f,{o:function(t,r){for(let e=0;e<Math.max(1,t.length);e+=6){const n=$vBools2Mask([!0,e+6>=t.length,...t.slice(e,e+6)]);r.u(n)}},$:function(t){const r=[];let e=!1;for(;!e;){const n=[...(t.S()>>>0).toString(2)].map((t=>"0"!=t));n.shift(),e=n.shift(),r.push(...n)}return r}},{o:function(t,r){r.u($bools2Mask(t,8))},$:function(t){return $mask2Bools(t.S(),8)}},{o:function(t,r){r.h($bools2Mask(t,16))},$:function(t){return $mask2Bools(t.B(),16)}},{o:function(t,r){r.l($bools2Mask(t,32))},$:function(t){return $mask2Bools(t.m(),32)}},s,a,u,c,h],setTinybufConfig=t=>{w=Object.assign(Object.assign({},w),t)};let w={safe:!1,useGlobalEncodingBuffer:!0,encodingBufferMaxSize:1500,encodingBufferInitialSize:256,encodingBufferIncrement:256};function f16round(t){return $(l(t))}const l=function(){const t=new Float32Array(1),r=new Uint32Array(t.buffer);return function(e){t[0]=e;const n=r[0],i=n>>23&255;if(i<113){if(i<103)return n>>16&32768;let t=n>>12&2047;return t|=2048,n>>16&32768|t>>113-i+(t>>112-i)&1}if(i>=142){if(e>65504)return 31744;if(e<-65504)return 64512;if(e!=e)return 31745}const o=n>>12&2047;return n>>16&32768|i-112<<10|(o>>1)+(1&o)}}(),$=function(){let t;return function $f16unmask(r){if(!t){const r=Math.pow(2,-24),precalc=function(t,e){return 0===t?0===e?0:r*(e/1024):31===t?0===e?1/0:NaN:(t-=15,Math.pow(2,t)*(1+e/1024))};t=[];for(let r=0;r<32;r++)for(let e=0;e<1024;e++){const n=precalc(r,e);t[(r<<10)+e]=n}}return 32768&r?-t[((r>>10&31)<<10)+(1023&r)]:t[((r>>10&31)<<10)+(1023&r)]}}();class BufferWriter{constructor(t){this.C=0,t instanceof ArrayBuffer?(this.V=t,this.W=!1):(this.V=new ArrayBuffer(t),this.W=!0),this.J=new DataView(this.V,0,this.V.byteLength)}P(){return new Uint8Array(this.J.buffer,0,this.C)}q(){return new Uint8Array(this.J.buffer.slice(0,this.C))}k(t){this.J.setInt8(this.G(1),t)}M(t){this.J.setInt16(this.G(2),t,!0)}N(t){this.J.setInt32(this.G(4),t,!0)}u(t){this.J.setUint8(this.G(1),t)}h(t){this.J.setUint16(this.G(2),t)}l(t){this.J.setUint32(this.G(4),t)}j(t){this.J.setUint16(this.G(2),l(t))}D(t){this.J.setFloat32(this.G(4),t,!0)}O(t){this.J.setFloat64(this.G(8),t,!0)}T(t){const r=this.G(t.byteLength),e=t instanceof Uint8Array?t:t instanceof ArrayBuffer?new Uint8Array(t):new Uint8Array(t.buffer,t.byteOffset,t.byteLength);new Uint8Array(this.J.buffer,r,t.byteLength).set(e)}G(t){if(this.C+t<=this.J.byteLength){const r=this.C;return this.C+=t,r}const r=this.J.byteLength,e=r+t;if(!this.W||e>w.encodingBufferMaxSize)throw new EncodeError(`exceeded max encoding buffer size: ${w.encodingBufferMaxSize}`);let n=this.J.byteLength;do{n=Math.min(n+w.encodingBufferIncrement,w.encodingBufferMaxSize)}while(n<this.C+t);const i=new ArrayBuffer(n),o=new Uint8Array(this.J.buffer,this.J.byteOffset,r);new Uint8Array(i).set(o),this.V=i,this.J=new DataView(i);const s=this.C;return this.C+=t,s}}class BufferReader{constructor(t,r){this.J=t instanceof ArrayBuffer?new DataView(t):new DataView(t.buffer,t.byteOffset,t.byteLength),this.i=null!=r?r:0}p(){return this.J.getUint8(this.i)}F(){this.i++}S(){return this.J.getUint8(this.i++)}B(){const t=this.J.getUint16(this.i);return this.i+=2,t}m(){const t=this.J.getUint32(this.i);return this.i+=4,t}U(){return this.J.getInt8(this.i++)}v(){const t=this.J.getInt16(this.i,!0);return this.i+=2,t}I(){const t=this.J.getInt32(this.i,!0);return this.i+=4,t}_(){const t=this.J.getUint16(this.i);return this.i+=2,$(t)}H(){const t=this.J.getFloat32(this.i,!0);return this.i+=4,t}R(){const t=this.J.getFloat64(this.i,!0);return this.i+=8,t}A(t){if(this.i+t>this.J.byteLength)throw new RangeError;const r=new Uint8Array(this.J.buffer,this.i,t);return this.i+=t,r}}class OptionalType{constructor(t){this.type=t}}function optional(t){return new OptionalType(t)}function defineFormat(t,r){return null!==t&&"object"==typeof t?new BufferFormat(t):new BufferFormat(r,t)}class BufferFormat{constructor(t,r){if(this.K=!1,t instanceof OptionalType)throw new TypeError("Invalid encoding format: Root object cannot be optional.");if(void 0!==t&&"number"==typeof t)this.L=t;else{if(!(t instanceof Object))throw new TypeError("Invalid encoding format: Must be an object, or a known coder type.");if(this.L=void 0,this.X=new Map,this.Y=Object.keys(t).map((r=>{const e=new Field(r,t[r]);return this.X.set(r,e),e})),void 0===r)this.header=$hashCode(this.f),this.Z=this.header;else if(null===r)this.header=void 0,this.Z=void 0;else{if(!function isValidHeader(t){return"number"==typeof t?Number.isInteger(t)&&t>=0&&t<=65535:"string"==typeof t&&2===(new TextEncoder).encode(t).byteLength}(r))throw new TypeError(`Header should be an integer between 0 and 65535, a 2-byte string, or null. Received: ${r}`);this.header=r,this.Z="number"==typeof r?r:$strToHashCode(r)}}}get f(){return void 0===this.tt&&(this.tt=void 0!==this.Y?`{${this.Y.map((t=>t.f)).join(",")}}`:`${this.L}`),this.tt}static rt(){return w.useGlobalEncodingBuffer?(BufferFormat.et||(BufferFormat.et=new ArrayBuffer(w.encodingBufferMaxSize)),new BufferWriter(BufferFormat.et)):new BufferWriter(w.encodingBufferInitialSize)}encode(t,r){return this.nt||(this.nt=BufferFormat.rt()),this.nt.C=0,this.K&&(t=this.it(t)),this.ot(t,this.nt,""),(null!=r?r:w.safe)?this.nt.q():this.nt.P()}decode(t){return this.st(new BufferReader(t,void 0===this.header?0:2))}setTransforms(t){if(this.K=!0,t instanceof Function||Array.isArray(t)&&t[0]instanceof Function)this.ft=t;else for(const r of Object.keys(t)){const e=this.X.get(r);if(!e)throw new TypeError(`Failed to set transforms for field '${r}'`);e.ut.setTransforms(t[r])}return this}setValidation(t){if(this.K=!0,t instanceof Function)this.ct=t;else for(const r of Object.keys(t)){const e=this.X.get(r);if(!e)throw new TypeError(`Failed to set validation function for field '${r}'`);e.ut.setValidation(t[r])}return this}ot(t,r,e){if(void 0!==this.Z&&this.nt.h(this.Z),void 0!==this.L){const n=this.ct||this.ft?this.it(t):t;return d[this.L].o(n,r,e)}if(!t||"object"!=typeof t)throw new TypeError(`Expected an object at ${e}`);for(const n of this.Y){const i=e?`${e}.${n.ht}`:n.ht,o=t[n.ht];if(n.dt){if(null==o){f.o(!1,r);continue}f.o(!0,r)}n.wt?this.lt(o,r,i,n.ut):n.ut.ot(o,r,i)}}it(t){if(this.ct&&!1===this.ct(t))throw new Error("failed validation");return this.ft instanceof Function?this.ft(t):Array.isArray(this.ft)&&this.ft[0]instanceof Function?this.ft[0](t):t}$t(t){return Array.isArray(this.ft)&&this.ft[1]instanceof Function&&(t=this.ft[1](t)),this.ct instanceof Function&&this.ct(t),t}st(t){return this.st=this.yt(),this.st(t)}Et(){return`return{${this.Y.map((({ht:t},r)=>`${t}:this.${this.bt.name}(${r},state)`)).join(",")}}`}bt(t,r){const e=this.Y[t];if(!e.dt||this.Bt(r))return e.wt?this.Ft(e.ut,r):e.ut.st(r)}yt(){return void 0!==this.L?this.K?t=>this.$t(d[this.L].$(t)):d[this.L].$:new Function("state",this.Et())}lt(t,r,e,n){if(!Array.isArray(t))throw new EncodeError(`Array<${n.L}>`,r,e);let o,s;for(s=t.length,i.o(s,r),o=0;o<s;o++)n.ot(t[o],r,e+"."+o)}Ft(t,r){const e=new Array(i.$(r));for(let n=0;n<e.length;n++)e[n]=t.st(r);return e}Bt(t){return f.$(t)}}BufferFormat.peekHeader=peekHeader,BufferFormat.peekHeaderStr=peekHeaderStr;class Field{constructor(t,r){this.dt=r instanceof OptionalType;let e=r instanceof OptionalType?r.type:r;if(this.ht=t,Array.isArray(e)){if(1!==e.length)throw new TypeError("Invalid array definition, it must have exactly one element");e=e[0],this.wt=!0}else this.wt=!1;this.ut=new BufferFormat(e,null)}get f(){return void 0===this.Tt&&(this.Tt=`${this.ut.f}${this.wt?"[]":""}${this.dt?"?":""}`),this.Tt}}const p=f16round;export{DecodeError,EncodeError,TinybufError,bufferParser,defineFormat,f16round,p as fround16,optional,peekHeader,peekHeaderStr,scalarRound,setTinybufConfig,uScalarRound};
//# sourceMappingURL=index.mjs.map
