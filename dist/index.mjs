class TinyBufError extends Error{}class UnrecognizedFormatError extends TinyBufError{}class FormatHeaderCollisionError extends TinyBufError{}class BufferDecodingError extends TinyBufError{constructor(t,r){super(`${t}: ${r.message}`),this.underlying=r,this.stack=r.stack}}class WriteTypeError extends TinyBufError{constructor(t,r,e){super(`Expected '${t}', instead received: ${r} (type: ${typeof r}) (at path: '${e||"<root>"}')`)}}class BufferEncodingError extends TinyBufError{}function djb2HashUInt16(t){let r=5381;for(let e=0;e<t.length;e++)r=33*r^t.charCodeAt(e);return 65535&r}const t=djb2HashUInt16;function strToHashCode(t){return 2===t.length?256*t.charCodeAt(0)+t.charCodeAt(1):djb2HashUInt16(t)}function hashCodeToStr(t){return String.fromCharCode(Math.floor(t/256))+String.fromCharCode(t%256)}function peekHeader(t){return new DataView(t instanceof ArrayBuffer?t:t.buffer).getUint16(0,!1)}function peekHeaderStr(t){return hashCodeToStr(peekHeader(t))}const bufferParser=()=>new BufferParserInstance;class BufferParserInstance{constructor(){this.formats=new Map}get availableFormats(){return new Set([...this.formats.values()].map((t=>t[0])))}processBuffer(t){let r;try{r=peekHeader(t)}catch(t){throw new BufferDecodingError("Failed to process buffer",t)}if(!this.formats.has(r))throw new UnrecognizedFormatError(`Unrecognized format (uint16: ${r}, str: '${hashCodeToStr(r)}')`);const[e,n]=this.formats.get(r);let i;try{i=e.decode(t)}catch(t){throw new BufferDecodingError(`Failed to decode data to format '${e.header}'`,t)}n(i)}on(t,r,e=!1){if(null==t.header)throw new TypeError("Cannot register a headerless encoding format.");const n="string"==typeof t.header?strToHashCode(t.header):t.header;if(this.formats.has(n)&&!e)throw new FormatHeaderCollisionError(`Format with identical header was already registered: ${t.header}`);return this.formats.set(n,[t,r]),this}ignore(...t){return t.forEach((t=>this.on(t,(()=>{}),!0))),this}clear(){this.formats.clear()}}function isBooleanArray(t){return Array.isArray(t)&&t.every((t=>"boolean"==typeof t))}function fixedLengthBooleanArrayToBitmask(t,r){let e="";for(let n=0;n<r;n++)e+=+!!t[n];return parseInt(e,2)}function bools2Mask(t){let r="";for(let e=0;e<t.length;e++)r+=+!!t[e];return parseInt(r,2)}function mask2Bools(t,r){return[...(t>>>0).toString(2).padStart(r,"0")].map((t=>"0"!=t))}function clamp(t,r,e){return Math.min(Math.max(t,r),e)}function r2z(t){return t<0?Math.ceil(t):Math.floor(t)}function raz(t){return t<0?Math.floor(t):Math.ceil(t)}function toUScalar8(t){return Number.isNaN(t)?255:clamp(127+r2z(254*t-127),0,254)}function toScalar8(t){return Number.isNaN(t)?255:clamp(r2z(127*t),-127,127)+127}function fromUScalar8(t){return 255===t?NaN:clamp(.01*(raz(.3937007874015748*(t-127))+50),0,1)}function fromScalar8(t){return 255===t?NaN:clamp(.01*raz(.787401574803149*(t-127)),-1,1)}function uScalarRound(t){return fromUScalar8(toUScalar8(t))}function scalarRound(t){return fromScalar8(toScalar8(t))}const r=268435456,e=2147483647,n=4294967296,i=new TextDecoder("utf-8"),a={write:function(t,r,e){if("number"!=typeof t||t>Number.MAX_SAFE_INTEGER||t<0)throw new WriteTypeError("uint",t,e);const i=r2z(t);i<128?r.writeUInt8(i):i<16384?r.writeUInt16(i+32768):i<536870912?r.writeUInt32(i+3221225472):(r.writeUInt32(Math.floor(i/n)+3758096384),r.writeUInt32(i>>>0))},read:function(t){const r=t.peekUInt8();return 128&r?64&r?32&r?(t.readUint32()-3758096384)*n+t.readUint32():t.readUint32()-3221225472:t.readUint16()-32768:(t.skipByte(),r)}},o={write:function(t,r,e){if("number"!=typeof t||t<0||t>255)throw new WriteTypeError("uint8",t,e);r.writeUInt8(r2z(t))},read:function(t){return t.readUint8()}},s={write:function(t,r,e){if("number"!=typeof t||t<0||t>65535)throw new WriteTypeError("uint16",t,e);r.writeUInt16(r2z(t))},read:function(t){return t.readUint16()}},f={write:function(t,r,e){if("number"!=typeof t||t<0||t>4294967295)throw new WriteTypeError("uint32",t,e);r.writeUInt32(r2z(t))},read:function(t){return t.readUint32()}},u={write:function(t,e,i){if("number"!=typeof t||t>Number.MAX_SAFE_INTEGER||t<-Number.MAX_SAFE_INTEGER)throw new WriteTypeError("int",t,i);const a=r2z(t);a>=-64&&a<64?e.writeUInt8(127&a):a>=-8192&&a<8192?e.writeUInt16(32768+(16383&a)):a>=-268435456&&a<r?e.writeUInt32(3221225472+(536870911&a)):(e.writeUInt32(3758096384+(536870911&Math.floor(a/n))),e.writeUInt32(a>>>0))},read:function(t){let r,e=t.peekUInt8();return 128&e?64&e?32&e?(r=t.readUint32()-3758096384,r=268435456&r?3758096384|r:r,r*n+t.readUint32()):(r=t.readUint32()-3221225472,268435456&r?3758096384|r:r):(r=t.readUint16()-32768,8192&r?4294950912|r:r):(t.skipByte(),64&e?4294967168|e:e)}},c={write:function(t,r,e){if("number"!=typeof t||t<-127||t>127)throw new WriteTypeError("int8",t,e);r.writeInt8(r2z(t))},read:function(t){return t.readInt8()}},d={write:function(t,r,e){if("number"!=typeof t||t<-32767||t>32767)throw new WriteTypeError("int16",t,e);r.writeInt16(r2z(t))},read:function(t){return t.readInt16()}},h={write:function(t,r,n){if("number"!=typeof t||t<-e||t>e)throw new WriteTypeError("int32",t,n);r.writeInt32(r2z(t))},read:function(t){return t.readInt32()}},l={write:function(t,r,e){if("number"!=typeof t)throw new WriteTypeError("number",t,e);r.writeFloat16(t)},read:function(t){return t.readFloat16()}},w={write:function(t,r,e){if("number"!=typeof t)throw new WriteTypeError("number",t,e);r.writeFloat32(t)},read:function(t){return t.readFloat32()}},y={write:function(t,r,e){if("number"!=typeof t)throw new WriteTypeError("number",t,e);r.writeFloat64(t)},read:function(t){return t.readFloat64()}},p={write:function(t,r,e){if("number"!=typeof t)throw new WriteTypeError("number",t,e);r.writeUInt8(toUScalar8(t))},read:function(t){return fromUScalar8(t.readUint8())}},m={write:function(t,r,e){if("number"!=typeof t)throw new WriteTypeError("number",t,e);r.writeUInt8(toScalar8(t))},read:function(t){return fromScalar8(t.readUint8())}},b={write:function(t,r,e){g.write((new TextEncoder).encode(null!=t?t:""),r,e)},read:function(t){return i.decode(g.read(t))}},g={write:function(t,r,e){a.write(t.byteLength,r,e),r.writeBuffer(t)},read:function(t){return t.readBuffer(a.read(t))}},U={write:function(t,r,e){if("boolean"!=typeof t)throw new WriteTypeError("boolean",t,e);r.writeUInt8(t?1:0)},read:function(t){const r=t.readUint8();return Boolean(0!==r)}},B={write:function(t,r,e){if(!isBooleanArray(t))throw new WriteTypeError("boolean[]",t,e);for(let e=0;e<Math.max(1,t.length);e+=6){const n=bools2Mask([!0,e+6>=t.length,...t.slice(e,e+6)]);r.writeUInt8(n)}},read:function(t){const r=[];let e=!1;for(;!e;){const n=t.readUint8(),i=[...(n>>>0).toString(2)].map((t=>"0"!=t));i.shift(),e=i.shift(),r.push(...i)}return r}},E={write:function(t,r,e){if(!isBooleanArray(t))throw new WriteTypeError("boolean[]",t,e);const n=fixedLengthBooleanArrayToBitmask(t,8);r.writeUInt8(n)},read:function(t){return mask2Bools(t.readUint8(),8)}},T={write:function(t,r,e){if(!isBooleanArray(t))throw new WriteTypeError("boolean[]",t,e);const n=fixedLengthBooleanArrayToBitmask(t,16);r.writeUInt16(n)},read:function(t){return mask2Bools(t.readUint16(),16)}},F={write:function(t,r,e){if(!isBooleanArray(t))throw new WriteTypeError("boolean[]",t,e);const n=fixedLengthBooleanArrayToBitmask(t,32);r.writeUInt32(n)},read:function(t){return mask2Bools(t.readUint32(),32)}},I={write:function(t,r,e){let n;try{n=JSON.stringify(t)}catch(t){throw new WriteTypeError("JSON",t,e)}b.write(n,r,e)},read:function(t){const r=b.read(t);return JSON.parse(r)}},A={write:function(t,r,e){if(!(t instanceof RegExp))throw new WriteTypeError("RegExp",t,e);let n,i,a;b.write(t.source,r,e),n=t.global?1:0,i=t.ignoreCase?2:0,a=t.multiline?4:0,r.writeUInt8(n+i+a)},read:function(t){const r=b.read(t),e=t.readUint8();return new RegExp(r,(1&e?"g":"")+(2&e?"i":"")+(4&e?"m":""))}},S={write:function(t,r,e){if(!(t instanceof Date))throw new WriteTypeError("Date",t,e);{const n=t.getTime();if(isNaN(n))throw new WriteTypeError("Date","NaN",e);u.write(n,r,e)}},read:function(t){return new Date(u.read(t))}},_=1500,k={useSharedWriteBuffer:!0,writeBufferDefaultSize:375,writeBufferIncrement:750,writeBufferMaxSize:_};var W;const x=10,v=31,N=1023,z=Math.pow(2,-24),$=function(){const t=new Float32Array(1),r=new Int32Array(t.buffer);return function toHalf(e){t[0]=e;const n=r[0];let i=n>>16&32768,a=n>>12&2047;const o=n>>23&255;return o<103?i:o>142?isNaN(e)?31745:(i|=31744,i|=(255==o?0:1)&&8388607&n,i):o<113?(a|=2048,i|=(a>>114-o)+(a>>113-o&1),i):(i|=o-112<<10|a>>1,i+=1&a,i)}}();function fromFloat16(t){const r=t>>x&v,e=t&N;return(32768&t?-1:1)*f16.t[(r<<x)+e]}function fround16(t){return fromFloat16($(t))}class f16{static _initFloat16LookupTable(){const t=[];for(let r=0;r<32;r++)for(let e=0;e<1<<x;e++){const n=f16.precalc(r,e);t[(r<<x)+e]=n}return t}static precalc(t,r){return 0===t?0===r?0:z*(r/1024):31===t?0===r?1/0:NaN:(t-=15,Math.pow(2,t)*(1+r/1024))}}W=f16,f16.t=W._initFloat16LookupTable();class BufferWriter{constructor(t){this.o=0;const r=t&&!k.useSharedWriteBuffer?BufferWriter.sharedBuffer:new ArrayBuffer(null!=t?t:k.writeBufferDefaultSize);this.data=new DataView(r)}get allocatedBytes(){return this.data.byteLength}asView(){return new Uint8Array(this.data.buffer,0,this.o)}copy(){return new Uint8Array(this.data.buffer.slice(0,this.o))}writeBuffer(t){const r=this.alloc(t.byteLength),e=t instanceof Uint8Array?t:t instanceof ArrayBuffer?new Uint8Array(t):new Uint8Array(t.buffer,t.byteOffset,t.byteLength);new Uint8Array(this.data.buffer,r,t.byteLength).set(e)}writeInt8(t){this.data.setInt8(this.alloc(1),t)}writeInt16(t){this.data.setInt16(this.alloc(2),t,!0)}writeInt32(t){this.data.setInt32(this.alloc(4),t,!0)}writeUInt8(t){this.data.setUint8(this.alloc(1),t)}writeUInt16(t){this.data.setUint16(this.alloc(2),t)}writeUInt32(t){this.data.setUint32(this.alloc(4),t)}writeFloat16(t){this.data.setUint16(this.alloc(2),$(t))}writeFloat32(t){this.data.setFloat32(this.alloc(4),t)}writeFloat64(t){this.data.setFloat64(this.alloc(8),t)}alloc(t){const r=this.o;if(this.o+t<=this.data.byteLength)return this.o+=t,r;const e=this.data.byteLength,n=e+t;if(n>k.writeBufferMaxSize)throw new BufferEncodingError(`Write buffer exceeded maximum size. Bytes requested: ${n}. SETTINGS.writeBufferMaxSize: ${k.writeBufferMaxSize}.`);let i=this.data.byteLength;do{i=Math.min(i+k.writeBufferIncrement,k.writeBufferMaxSize)}while(i<this.o+t);const a=new ArrayBuffer(i),o=new Uint8Array(this.data.buffer,this.data.byteOffset,e);return new Uint8Array(a).set(o),k.useSharedWriteBuffer&&(BufferWriter.sharedBuffer=a),this.data=new DataView(a),this.o+=t,r}}BufferWriter.sharedBuffer=new ArrayBuffer(k.writeBufferDefaultSize);class BufferReader{constructor(t,r){this.data=t instanceof ArrayBuffer?new DataView(t):new DataView(t.buffer,t.byteOffset,t.byteLength),this.i=null!=r?r:0}get hasEnded(){return this.i===this.data.byteLength}peekUInt8(){return this.data.getUint8(this.i)}skipByte(){this.i++}readUint8(){return this.data.getUint8(this.i++)}readUint16(){const t=this.data.getUint16(this.i);return this.i+=2,t}readUint32(){const t=this.data.getUint32(this.i);return this.i+=4,t}readInt8(){return this.data.getInt8(this.i++)}readInt16(){const t=this.data.getInt16(this.i,!0);return this.i+=2,t}readInt32(){const t=this.data.getInt32(this.i,!0);return this.i+=4,t}readFloat16(){const t=this.data.getUint16(this.i);return this.i+=2,fromFloat16(t)}readFloat32(){const t=this.data.getFloat32(this.i);return this.i+=4,t}readFloat64(){const t=this.data.getFloat64(this.i);return this.i+=8,t}readBuffer(t){if(this.i+t>this.data.byteLength)throw new RangeError("Trying to access beyond byte length");const r=new Uint8Array(this.data.buffer,this.i,t);return this.i+=t,r}}const C=["float16","float32","float64","int","int8","int16","int32","uint","uint8","uint16","uint32","uscalar","scalar","bool","booltuple","bitmask8","bitmask16","bitmask32","str","date","regex","json","buf"];class OptionalType{constructor(t){this.type=t}}function optional(t){return new OptionalType(t)}function defineFormat(t,r){return null!==t&&"object"==typeof t?new BufferFormat(t):new BufferFormat(r,t)}class BufferFormat{constructor(t,r){if(t instanceof OptionalType)throw new TypeError("Invalid encoding format: Root object cannot be optionals.");if(void 0!==t&&"string"==typeof t&&C.includes(t))this.type=t;else{if(!(t instanceof Object))throw new TypeError("Invalid encoding format: Must be an object, or a known coder type.");this.type="{object}",this.fields=Object.keys(t).map((r=>new Field(r,t[r])))}if(void 0===r&&"{object}"===this.type)this.header=this.hashCode;else if(null===r)this.header=void 0;else{if(!function isValidHeader(t){return"number"==typeof t?Number.isInteger(t)&&t>=0&&t<=65535:"string"==typeof t&&2===(new TextEncoder).encode(t).byteLength}(r))throw new TypeError(`Header should be an integer between 0 and 65535, a 2-byte string, or null. Received: ${r}`);this.header=r}}get hashCode(){return void 0===this._hash&&(this._hash=t(this.format)),this._hash}get format(){return void 0===this._format&&(this._format="{object}"===this.type?`{${this.fields.map((t=>t.format)).join(",")}}`:`${this.type}`),this._format}encode(t,r=!1){const e=this._preEncode(t),n=new BufferWriter(r?k.writeBufferDefaultSize:void 0);return null!=this.header&&this.writeHeader(n),this.write(e,n,""),r?n.copy():n.asView()}decode(t){return this.read(new BufferReader(t,void 0===this.header?0:2))}setTransforms(t){if(t instanceof Function||Array.isArray(t)&&t[0]instanceof Function)this._transforms=t;else for(const r of Object.keys(t)){const e=this.fields.find((t=>t.name===r));if(!e)throw new TypeError(`Failed to set transforms for field '${r}'`);e.coder.setTransforms(t[r])}return this}setValidation(t){if(t instanceof Function)this._validationFn=t;else for(const r of Object.keys(t)){const e=this.fields.find((t=>t.name===r));if(!e)throw new TypeError(`Failed to set validation function for field '${r}'`);e.coder.setValidation(t[r])}return this}write(t,r,e){if("{object}"!==this.type){const n=this._validationFn||this._transforms?this._preEncode(t):t;return this.getCoder(this.type).write(n,r,e)}if(!t||"object"!=typeof t)throw new TypeError(`Expected an object at ${e}`);for(const n of this.fields){const i=e?`${e}.${n.name}`:n.name,a=t[n.name];if(n.isOptional){if(null==a){U.write(!1,r);continue}U.write(!0,r)}n.isArray?this._writeArray(a,r,i,n.coder):n.coder.write(a,r,i)}}writeHeader(t){const r="string"==typeof this.header?strToHashCode(this.header):this.header;s.write(r,t,"")}getCoder(t){switch(t){case"buf":return g;case"bool":return U;case"booltuple":return B;case"bitmask8":return E;case"bitmask16":return T;case"bitmask32":return F;case"date":return S;case"float16":return l;case"float32":return w;case"float64":return y;case"uscalar":return p;case"scalar":return m;case"int":return u;case"int16":return d;case"int32":return h;case"int8":return c;case"json":return I;case"regex":return A;case"str":return b;case"uint":return a;case"uint16":return s;case"uint32":return f;case"uint8":return o}}_preEncode(t){if(this._validationFn&&!1===this._validationFn(t))throw new Error("custom validation failed");return this._transforms instanceof Function?this._transforms(t):Array.isArray(this._transforms)&&this._transforms[0]instanceof Function?this._transforms[0](t):t}_postDecode(t){return Array.isArray(this._transforms)&&this._transforms[1]instanceof Function&&(t=this._transforms[1](t)),this._validationFn instanceof Function&&this._validationFn(t),t}read(t){return this.read=this.compileRead(),this.read(t)}generateObjectReadCode(){return`return{${this.fields.map((({name:t},r)=>`${t}:this.${this._readField.name}(${r},state)`)).join(",")}}`}_readField(t,r){const e=this.fields[t];if(!e.isOptional||this._readOptional(r))return e.isArray?this._readArray(e.coder,r):e.coder.read(r)}readValueType(t){return this._postDecode(this.getCoder(this.type).read(t))}compileRead(){if("{object}"!==this.type&&"[array]"!==this.type)return void 0!==this._validationFn||void 0!==this._transforms?this.readValueType:this.getCoder(this.type).read;const t=this.generateObjectReadCode();return new Function("state",t)}_writeArray(t,r,e,n){let i,o;if(!Array.isArray(t))throw new WriteTypeError(`Array<${n.type}>`,r,e);for(o=t.length,a.write(o,r),i=0;i<o;i++)n.write(t[i],r,e+"."+i)}_readArray(t,r){const e=new Array(a.read(r));for(let n=0;n<e.length;n++)e[n]=t.read(r);return e}_readOptional(t){return U.read(t)}}BufferFormat.peekHeader=peekHeader,BufferFormat.peekHeaderStr=peekHeaderStr;class Field{constructor(t,r){this.isOptional=r instanceof OptionalType;let e=r instanceof OptionalType?r.type:r;if(this.name=t,Array.isArray(e)){if(1!==e.length)throw new TypeError("Invalid array definition, it must have exactly one element");e=e[0],this.isArray=!0}else this.isArray=!1;this.coder=new BufferFormat(e,null)}get format(){return void 0===this._format&&(this._format=`${this.coder.format}${this.isArray?"[]":""}${this.isOptional?"?":""}`),this._format}}export{BufferDecodingError,BufferEncodingError,BufferFormat,BufferParserInstance,FormatHeaderCollisionError,k as SETTINGS,TinyBufError,UnrecognizedFormatError,WriteTypeError,bufferParser,defineFormat,fromFloat16,fromScalar8,fromUScalar8,fround16,optional,peekHeader,peekHeaderStr,scalarRound,$ as toFloat16,toScalar8,toUScalar8,uScalarRound};
//# sourceMappingURL=index.mjs.map
